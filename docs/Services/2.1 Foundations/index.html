<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Services/2.1 Foundations/2.1 Foundations">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/The-Standard/blog/rss.xml" title="The Standard ❤️ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/The-Standard/blog/atom.xml" title="The Standard ❤️ Atom Feed"><title data-rh="true">2.1 Foundation Services (Broker-Neighboring) | The Standard ❤️</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://francofgp.github.io/The-Standard/docs/Services/2.1 Foundations/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="2.1 Foundation Services (Broker-Neighboring) | The Standard ❤️"><meta data-rh="true" name="description" content="2.1.0 Introduction"><meta data-rh="true" property="og:description" content="2.1.0 Introduction"><link data-rh="true" rel="icon" href="/The-Standard/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://francofgp.github.io/The-Standard/docs/Services/2.1 Foundations/"><link data-rh="true" rel="alternate" href="https://francofgp.github.io/The-Standard/docs/Services/2.1 Foundations/" hreflang="en"><link data-rh="true" rel="alternate" href="https://francofgp.github.io/The-Standard/docs/Services/2.1 Foundations/" hreflang="x-default"><link rel="stylesheet" href="/The-Standard/assets/css/styles.95b304a2.css">
<link rel="preload" href="/The-Standard/assets/js/runtime~main.06584d35.js" as="script">
<link rel="preload" href="/The-Standard/assets/js/main.1bcd0719.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/The-Standard/"><div class="navbar__logo"><img src="/The-Standard/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/The-Standard/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">The Standard</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/The-Standard/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/The-Standard/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/The-Standard/docs/Introduction/">0 Introduction</a><button aria-label="Toggle the collapsible sidebar category &#x27;0 Introduction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/The-Standard/docs/Brokers/">1 Brokers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/The-Standard/docs/Services/">2 Services</a><button aria-label="Toggle the collapsible sidebar category &#x27;2 Services&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/The-Standard/docs/Services/2.1 Foundations/">2.1 Foundation Services (Broker-Neighboring)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/The-Standard/docs/Services/2.2 Processings/">2.2 Processing Services (Higher-Order Business Logic)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/The-Standard/docs/Services/2.3 Orchestrations/">2.3 Orchestration Services (Complex Higher Order Logic)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/The-Standard/docs/Services/2.4 Aggregations/">2.4 Aggregation Services (The Knot)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/The-Standard/docs/Exposers/">3 Exposers</a><button aria-label="Toggle the collapsible sidebar category &#x27;3 Exposers&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/The-Standard/docs/intro">The Standard (v 2.0.1)</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/The-Standard/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/The-Standard/docs/Services/"><span itemprop="name">2 Services</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">2.1 Foundation Services (Broker-Neighboring)</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>2.1 Foundation Services (Broker-Neighboring)</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="210-introduction">2.1.0 Introduction<a class="hash-link" href="#210-introduction" title="Direct link to heading">​</a></h2><p>Foundation services are the first point of contact between your business logic and the brokers.</p><p>In general, the broker-neighboring services are a hybrid of business logic and an abstraction layer for the processing operations where the higher-order business logic happens, which we will talk about further when we start exploring the processing services in the next section.</p><p>Broker-neighboring services main responsibility is to ensure the incoming and outgoing data through the system is validated and vetted structurally, logically and externally.</p><p>You can also think of broker-neighboring services as a layer of validation on top of the primitive operations the brokers already offer.</p><p>For instance, if a storage broker is offering <code>InsertStudentAsync(Student student)</code> as a method, then the broker-neighboring service will offer something as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;Student&gt; AddStudentAsync(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValidateStudent(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.storageBroker.InsertStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This makes broker-neighboring services nothing more than an extra layer of validation on top of the existing primitive operations brokers already offer.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="211-on-the-map">2.1.1 On The Map<a class="hash-link" href="#211-on-the-map" title="Direct link to heading">​</a></h2><p>The broker-neighboring services reside between your brokers and the rest of your application, on the left side higher-order business logic processing services, orchestration, coordination, aggregation or management services may live, or just simply a controller, a UI component or any other data exposure technology.</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/100716772-00eec800-336e-11eb-9064-8bfe2f8e3be2.png" class="img_ev3q"></p><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="212-characteristics">2.1.2 Characteristics<a class="hash-link" href="#212-characteristics" title="Direct link to heading">​</a></h2><p>Foundation or Broker-Neighboring services in general have very specific characteristics that strictly govern their development and integration.</p><p>Foundation services in general focus more on validations than anything else - simply because that&#x27;s their purpose, to ensure all incoming and outgoing data through the system is in a good state for the system to process it safely without any issues.</p><p>Here&#x27;s the characteristics and rules that govern broker-neighboring services:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2120-pure-primitive">2.1.2.0 Pure-Primitive<a class="hash-link" href="#2120-pure-primitive" title="Direct link to heading">​</a></h3><p>Broker-neighboring services are not allowed to combine multiple primitive operations to achieve a higher-order business logic operation.</p><p>For instance, broker-neighboring services cannot offer an <em>upsert</em> function, to combine a <code>Select</code> operations with an <code>Update</code> or <code>Insert</code> operations based on the outcome to ensure an entity exists and is up to date in any storage.</p><p>But they offer a validation and exception handling (and mapping) wrapper around the dependency calls, here&#x27;s an example:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public ValueTask&lt;Student&gt; AddStudentAsync(Student student) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TryCatch(async () =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValidateStudent(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.storageBroker.InsertStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above method, you can see <code>ValidateStudent</code> function call preceded by a <code>TryCatch</code> block.
The <code>TryCatch</code> block is what I call Exception Noise Cancellation pattern, which we will discuss soon in this very section.</p><p>But the validation function ensures each and every property in the incoming data is validated before passing it forward to the primitive broker operation, which is the <code>InsertStudentAsync</code> in this very instance.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2121-single-entity-integration">2.1.2.1 Single Entity Integration<a class="hash-link" href="#2121-single-entity-integration" title="Direct link to heading">​</a></h3><p>Services strongly ensure the single responsibility principle is implemented by not integrating with any other entity brokers except for the one that it supports.</p><p>This rule doesn&#x27;t necessarily apply to support brokers like <code>DateTimeBroker</code> or <code>LoggingBroker</code> since they don&#x27;t specifically target any particular business entity and they are almost generic across the entire system.</p><p>For instance, a <code>StudentService</code> may integrate with a <code>StorageBroker</code> as long as it only targets only the functionality offered by the partial class in the <code>StorageBroker.Students.cs</code> file.</p><p>Foundation services should not integrate with more than one entity broker of any kind simply because it will increase the complexity of validation and orchestration which goes beyond the main purpose of the service which is just simply validation. We push this responsibility further to the orchestration-type services to handle it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2122-business-language">2.1.2.2 Business Language<a class="hash-link" href="#2122-business-language" title="Direct link to heading">​</a></h3><p>Broker-neighboring services speak primitive business language for their operations.
For instance, while a Broker may provide a method with the name <code>InsertStudentAsync</code> - the equivelant of that on the service layer would be <code>AddStudentAsync</code>.</p><p>In general, most of the CRUD operations shall be converted from a storage lanaugage to a business language, and the same goes for non-storage operations such as Queues, for instance we say <code>PostQueueMessage</code> but on the business layer we shall say <code>EnqueueMessage</code>.</p><p>Since the CRUD operations the most common ones in every system, our mapping to these CRUD operations would be as follows:</p><table><thead><tr><th>Brokers</th><th align="center">Services</th></tr></thead><tbody><tr><td>Insert</td><td align="center">Add</td></tr><tr><td>Select</td><td align="center">Retrieve</td></tr><tr><td>Update</td><td align="center">Modify</td></tr><tr><td>Delete</td><td align="center">Remove</td></tr></tbody></table><p>As we move forward towards higher-order business logic services, the language of the methods beings used will lean more towards a business language rather than a technology language as we will see in the upcoming sections.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="213-responsibilities">2.1.3 Responsibilities<a class="hash-link" href="#213-responsibilities" title="Direct link to heading">​</a></h2><p>Broker-neighboring services play three very important roles in any system.
The first role is to abstract away native broker operations from the rest of the system. Irregardless of whether a broker is a communication between a local or external storage or an API - broker-neighboring services will always have the same contract/verbiage to expose to upper stream services such as processing, orchestration or simply exposers like controllers or UI components.
The second and most important role is to offer a layer of validation on top of the existing primitive operations a broker already offers to ensure incoming and outgoing data is valid to be processed or persisted by the system.
The third role is to play the role of a mapper of all other native models and contracts that may be needed to completed any given operation while interfacing with a broker.
Foundation services are the last point of abstraction between the core business logic of any system and the rest of the world, let&#x27;s discuss these roles in detail.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2130-abstraction">2.1.3.0 Abstraction<a class="hash-link" href="#2130-abstraction" title="Direct link to heading">​</a></h3><p>The first and most important responsibility for foundation/broker-neighboring services is to ensure a level of abstraction exists between the brokers and the rest of your system. This abstraction is necessary to ensure the pure business logic layer in any system is verbally and functionally agnostic to whichever dependencies the system is relying on to communicate with the outside world.</p><p>Let&#x27;s visualize a concrete example of the above principle. Let&#x27;s assume we have a <code>StudentProcessingService</code> which implements an <code>UpsertStudentAsync</code> functionality. Somewhere in that implementation there will be a dependency on <code>AddStudentAsync</code> which is exposed and implemented by some <code>StudentService</code> as a foundation service. Take a look at this snippet:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;Student&gt; UpsertStudentAsync(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.studentService.AddStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The contract between a processing or an orchestration service and a foundation service will always be the same irregardless of what type of implementation or what type of brokers the foundation service is using.
For example, <code>AddStudentAsync</code> could be a call to a database or an API endpoint or simply putting a message on a queue. It all doesn&#x27;t impact in any way, shape or form the upstream processing service implementation. here&#x27;s an example of three different implementations of a foundation service that wouldn&#x27;t change anything in the implementation of it&#x27;s upstream services:</p><p>With a storage broker:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;Student&gt; AddStudentAsync(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.storageBroker.InsertStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Or with a queue broker:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;Student&gt; AddStudentAsync(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.queueBroker.EnqueueStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>or with an API broker:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;Student&gt; AddStudentAsync(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.apiBroker.PostStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>here&#x27;s a visualization of that concept:</p><br><div><img loading="lazy" width="75%" src="https://user-images.githubusercontent.com/1453985/128610577-ee926ee2-a589-4f77-bf9d-dbff63d1c20d.png" class="img_ev3q"></div><br><p>In all of these above cases, the underlying implementation may change, but the exposed contract will always stay the same for the rest of the system. We will discuss in later chapters how the core, agnostic and abstreact business logic of your system starts with Processing services and ends with Management or Aggregation services.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21301-implementation">2.1.3.0.1 Implementation<a class="hash-link" href="#21301-implementation" title="Direct link to heading">​</a></h4><p>Let&#x27;s talk about a real-life example of implementing a simple <code>Add</code> function in a foundation service. Let&#x27;s assume we have the following contract for our <code>StudentService</code>:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public IStudentService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValueTask&lt;Student&gt; AddStudentAsync(Student student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For starters, let&#x27;s go ahead and write a failing test for our service as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async Task ShouldAddStudentAsync()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // given</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student randomStudent = CreateRandomStudent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student inputStudent = randomStudent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student storageStudent = inputStudent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student expectedStudent = storageStudent.DeepClone();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.Setup(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.InsertStudentAsync(inputStudent))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ReturnsAsync(storageStudent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student actualStudent =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await this.studentService.AddStudentAsync(inputStudent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actualStudent.Should().BeEquivalentTo(expectedStudent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBroker.Verify(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.InsertStudentAsync(inputStudent),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBroker.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBroker.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above test, we defined four variables with the same value. Each variable contains a name that best fits the context it will be used in. For instance, <code>inputStudent</code> best fits in the input parameter position, while <code>storageStudent</code> best first what gets returned from the storage broker after a student is persisted sucessfully.</p><p>You will also notice that we deep cloned the <code>expectedStudent</code> variable to ensure no modifications have happened to the originally passed in student. For instance, assume an input student value has changed for any of it&#x27;s attributes internally within the <code>AddStudentAsync</code> function. That change won&#x27;t trigger a failing test unless we dereference the <code>expectedStudent</code> variable from the input and returned variables.</p><p>We mock the response from the storage broker and execute our subject of test <code>AddStudentAsync</code> then we verify the returned student value <code>actualStudent</code> matches the expected value <code>expectedStudent</code> regardless of the reference.</p><p>Finally, we verify all calls are done properly and no additional calls has been made to any of the service dependencies.</p><p>Let&#x27;s make that test pass by writing in an implementation that only satisfies the requirements of the aforementioned test:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;Student&gt; AddStudentAsync(Student student) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await this.storageBroker.InsertStudentAsync(student);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This simple implementation should make our test pass sucessfully. It&#x27;s important to understand that any implementation should be only enough to pass the failing tests. Nothing more and nothing less.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2131-validation">2.1.3.1 Validation<a class="hash-link" href="#2131-validation" title="Direct link to heading">​</a></h3><p>Foundation services are required to ensure incoming and outgoing data from and to the system are in a good state - they play the role of a gatekeeper between the system and the outside world to ensure the data that goes through is structurally, logically and externally valid before performing any further operations by upstream services.
The order of validations here is very intentional. Structural validations are the cheapest of all three types. They ensure a particular attribute or piece of data in general doesn&#x27;t have a default value if it&#x27;s required. the opposite of that is the logical validations, where attributes are compared to other attributes with the same entity or any other. Additional logical validations can also include a comparison with a constant value like comparing a student enrollment age to be no less than 5 years of age.
Both strucural and logical validations come before the external. As we said, it&#x27;s simply because we don&#x27;t want to pay the cost of communicating with an external resource including latency tax if our request is not in a good shape first.
For instance, we shouldn&#x27;t try to post some <code>Student</code> object to an external API if the object is <code>null</code>. Or if the <code>Student</code> model is invalid structurally or logically.</p><p>For all types of validations, it&#x27;s important to understand that some validations are circuit-breaking or requiring an immediate exit from the current flow by throwing an exception or returning a value in some cases. And some other validations are continuous. Let&#x27;s talk about these two sub categories of validations first.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21310-circuit-breaking-validations">2.1.3.1.0 Circuit-Breaking Validations<a class="hash-link" href="#21310-circuit-breaking-validations" title="Direct link to heading">​</a></h4><p>Circuit-breaking validations require an immediate exit from the current flow. For instance, if an object being passed into a function is <code>null</code> - there will be no further operations required at that level other than exiting the current flow by throwing an exception or returning a value of some type. Here&#x27;s an example:
In some validation scenario, assume that our <code>AddStudent</code> function has a student of value <code>null</code> passed into it as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Student noStudent = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">await this.studentService.AddStudentAsync(noStudent);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Our <code>AddStudentAsync</code> function in this scenario is now required to validate whether the passed in parameter is <code>null</code> or not before going any further with any other type of validations or the business logic itself. Something like this:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Student AddStudentAsync(Student student) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TryCatch(async () =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValidateStudent(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.storageBroker.InsertStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The statement in focus here is <code>ValidateStudent</code> function and what it does. Here&#x27;s an example of how that routine would be implemented:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void ValidateStudent(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if(student is null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NullStudentException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the function above, we decided to throw the exception immediately instead of going in further. That&#x27;s an example of circuit-breaking validation type.</p><p>But with validations, circuit-breaking isn&#x27;t always the wise thing to do. Sometimes we want to collect all the issues within a particular request before sending the error report back to the request submitter. Let&#x27;s talk about that in this next section.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21311-continuous-validations">2.1.3.1.1 Continuous Validations<a class="hash-link" href="#21311-continuous-validations" title="Direct link to heading">​</a></h4><p>Continuous validations are the opposite of circuit-breaking validations. They don&#x27;t stop the flow of validations but they definitely stop the flow of logic. In other words, continuous validations ensure no business logic will be executed but they also ensure other validations of the same type can continue to execute before breaking the circuit. Let&#x27;s materialize this theory with an example:
Assume our student model looks like this:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Student</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Guid Id {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string Name {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Assuming that the passed in <code>Student</code> model is not null, but it has default values across the board for all it&#x27;s properties. We want to collect all these issues for however many attributes/properties this object has and return a full report back to the requestor. Here&#x27;s how to do it.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="213110-upsertable-exceptions">2.1.3.1.1.0 Upsertable Exceptions<a class="hash-link" href="#213110-upsertable-exceptions" title="Direct link to heading">​</a></h4><p>A problem of that type requires a special type of exceptions that allow collecting all errors in it&#x27;s <code>Data</code> property. Every native exception out there will contain the <code>Data</code> property which is basically a dictionary for a key/value pairs for collecting more information about the issues that caused that exception to occur.
The issue with these native exceptions is that they don&#x27;t have native support for upsertion. Being able to append to an existing list of values against a particular key at any point of time.
Here&#x27;s a native implementation of upserting values in some given dictionary:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var someException = new Exception();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if(someException.Data.Contains(someKey))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (someException.Data[someKey] as List&lt;string&gt;)?.Add(someValue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    someException.Data.Add(someKey, new List&lt;string&gt;{ someValue });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This implementation can be quite daunting for engineers to think about and test in their service-level implementation. It felt more appropriate to introduce a simple library <code>Xeptions</code> to simplify the above implementation into something as simple as:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">var someException = new Xeption();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">someException.UpsertData(someKey, someValue);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now that we have this library to utilize, the concern of implementing upsertable exceptions has been addressed. This means that we have what it takes to collect our validation errors. But that&#x27;s not good enough if we don&#x27;t have a mechanism to break the circuit when we believe that the time is right to do so.
We can simply use the native offerings to implement the circuit-breaking directly as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if(someException.Data.Count &gt; 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw someException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And while this can be easily baked into any existing implementation. It still didn&#x27;t contribute much to overall look-n-feel of the code. Therefore I have decided to make it a part of the <code>Xeptions</code> library to be simplified to the following:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">someException.ThrowIfContainsErrors();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That would make our custom validations look something like this:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class InvalidStudentException : Xeption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public InvalidStudentException()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        : base (&quot;Student is invalid. Please fix the errors and try again.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But with continuous validations, the process of collecting these errors conveys more than just a special exception implementation. Let&#x27;s talk about that in the next section.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="213111-dynamic-rules">2.1.3.1.1.1 Dynamic Rules<a class="hash-link" href="#213111-dynamic-rules" title="Direct link to heading">​</a></h4><p>A non-circuit-breaking or continuous validation process will require the ability to pass in dynamic rules at any count or capacity to add these validation errors. A validation rule is a dynamic structure that reports whether the rule has been violated for its condition; and also the error message that should be reported to the end user to help them fix that issue.</p><p>In a scenario where we want to ensure any given Id is valid, a dynamic continuous validation rule would look something like this:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static dynamic IsInvalid(Guid id) =&gt; new</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Condition = id == Guid.Empty,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Message = &quot;Id is required&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now our Rule doesn&#x27;t just report whether a particular attribute is invalid or not. It also has a meaningful human-readable message that helps the consumer of the service understand what makes that very attribute invalid.</p><p>It&#x27;s really important to point out the language engineers must use for validation messages. It will all depend on the potential consumers of your system. A non-engineer will not understand a message such as <code>Text cannot be null, empty or whitespace</code> - <code>null</code> as a term isn&#x27;t something that is very commonly used. Engineers must work closely with their meatware (The people using the system) to ensure the language makes sense to them.</p><p>Dynamic rules by design will allow engineers to modify both their inputs and outputs without breaking any existing functionality as long as <code>null</code> values are considered across the board. Here&#x27;s another manifestation of a Dynamic Validation Rule:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static dynamic IsNotSame(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Guid firstId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Guid secondId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string secondIdName) =&gt; new</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Condition = firstId != secondId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Message = $&quot;Id is not the same as {secondIdName}.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HelpLink = &quot;/help/code1234&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Our dynamic rule now can offer more input parameters and more helpful information in terms of more detailed exception message with links to helpful documentation sites or references for error codes.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="213112-rules--validations-collector">2.1.3.1.1.2 Rules &amp; Validations Collector<a class="hash-link" href="#213112-rules--validations-collector" title="Direct link to heading">​</a></h4><p>Now that have the advanced exceptions and the dynamic validation rules. It&#x27;s time to put it all together in terms of accepting infinite number of validation rules, examining their condition results and finally break the circuit when all the continuous validations are done. here&#x27;s how to do that:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void Validate(params (dynamic Rule, string Parameter)[] validations)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var invalidStudentException = new InvalidStudentException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    foreach((dynamic rule, string parameter) in validations)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(rule.Condition)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            invalidStudentException.UpsertData(parameter, rule.Message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    invalidStudentException.ThrowIfContainsErrors();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above function now will take any number of validation rules, and the parameters the rule is running against then examine the conditions and upsert the report of errors. This is how we can use the method above:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void ValidateStudent(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Validate(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (Rule: IsInvalid(student.Id), Parameter: nameof(Student.Id)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (Rule: IsInvalid(student.Name), Parameter: nameof(Student.name)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (Rule: IsInvalid(student.Grade), Parameter: nameof(Student.Grade))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This simplification of writing the rules and validations is the ultimate goal of continuing to provide value to the end users while making the process of engineering the solution pleasant to the engineers themselves.</p><p>Now, let&#x27;s dive deeper into the types of validations that our systems can offer and how to handle them.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21312-structural-validations">2.1.3.1.2 Structural Validations<a class="hash-link" href="#21312-structural-validations" title="Direct link to heading">​</a></h4><p>Validations are three different layers. the first of these layers is the structural validations. to ensure certain properties on any given model or a primitive type are not in an invalid structural state.</p><p>For instance, a property of type <code>String</code> should not be empty, <code>null</code> or white space. another example would be for an input parameter of an <code>int</code> type, it should not be at it&#x27;s <code>default</code> state which is <code>0</code> when trying to enter an age for instance.</p><p>The structural validations ensure the data is in a good shape before moving forward with any further validations - for instance, we can&#x27;t possibly validate a student has the minimum number of characters (which is a logical validation) in their names if their first name is structurally invalid structurally by being <code>null</code>, empty or whitespace.</p><p>Structural validations play the role of identifying the <em>required</em> properties on any given model, and while a lot of technologies offer the validation annotations, plugins or libraries to globally enforce data validation rules, I choose to perform the validation programmatically and manually to gain more control of what would be required and what wouldn&#x27;t in a TDD fashion.</p><p>The issue with some of the current implementations on structural and logical validations on data models is that it can be very easily changed under the radar without any unit tests firing any alarms. Check this example for instance:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Student</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    [Required]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string Name {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above example can be very enticing at a glance from an engineering standpoint. All you have to do is decorate your model attribute with a magical annotation and then all of the sudden your data is being validated.</p><p>The problem here is that this pattern combines two different responsibilities or more together all in the same model. Models are supposed to be just a representation of objects in reality - nothing more and nothing less. Some engineers call them anemic models which focuses the responsibility of every single model to only represent the attributes of the real world object it&#x27;s trying to simulate without any additional details.</p><p>But the annotated models now try to inject business logic into their very definitions. This business logic may or may not be needed across all services, brokers or exposing components that uses them.</p><p>Structural validations on models may seem like extra work that can be avoided with magical decorations. But in the case of trying to diverge slightly from these validations into a more customized validations, now you will see a new anti-pattern emerge like custom annotations that may or may not be detectable through unit tests.</p><p>Let&#x27;s talk about how to test a structural validation routine:</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="213120-testing-structural-validations">2.1.3.1.2.0 Testing Structural Validations<a class="hash-link" href="#213120-testing-structural-validations" title="Direct link to heading">​</a></h5><p>Because I truly believe in the importance of TDD, I am going to start showing the implementation of structural validations by writing a failing test for it first.</p><p>Let&#x27;s assume we have a student model, with the following details:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Student</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Guid Id {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We want to validate that the student Id is not a structurally invalid Id - such as an empty <code>Guid</code> - therefore we would write a unit test in the following fashion:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Fact]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public async void ShouldThrowValidationExceptionOnRegisterWhenIdIsInvalidAndLogItAsync()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // given</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student randomStudent = CreateRandomStudent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student inputStudent = randomStudent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inputStudent.Id = Guid.Empty;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var invalidStudentException = new InvalidStudentException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    invalidStudentException.AddData(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key: nameof(Student.Id),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value: &quot;Id is required&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var expectedStudentValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new StudentValidationException(invalidStudentException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValueTask&lt;Student&gt; registerStudentTask =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.studentService.RegisterStudentAsync(inputStudent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StudentValidationException actualStudentValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await Assert.ThrowsAsync&lt;StudentValidationException&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerStudentTask.AsTask);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actualStudentValidationException.Should().BeEquivalentTo(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expectedStudentValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.Verify(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.LogError(It.Is(SameExceptionAs(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expectedStudentValidationException))),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.Verify(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.InsertStudentAsync(It.IsAny&lt;Student&gt;()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Times.Never);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.dateTimeBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above test, we created a random student object then assigned the an invalid Id value of <code>Guid.Empty</code> to the student <code>Id</code>.</p><p>When the structural validation logic in our foundation service examines the <code>Id</code> property, it should throw an exception property describing the issue of validation in our student model. in this case we throw <code>InvalidStudentException</code>.</p><p>The exception is required to briefly describe the whats, wheres and whys of the validation operation. in our case here the what would be the validation issue occurring, the where would be the Student service and the why would be the property value.</p><p>Here&#x27;s how an <code>InvalidStudentException</code> would look like:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class InvalidStudentException : Xeption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public InvalidStudentException()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        :base (&quot;Student is invalid. Please fix the errors and try again.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above unit test however, requires our <code>InvalidStudentException</code> to be wrapped up in a more generic system-level exception, which is <code>StudentValidationException</code> - these exceptions is what I call outer-exceptions, they encapsulate all the different situations of validations regardless of their category and communicates the error to upstream services or controllers so they can map that to the proper error code to the consumer of these services.</p><p>Our <code>StudentValidationException</code> would be implemented as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class StudentValidationException : Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public StudentValidationException(Exception innerException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        : base(&quot;Student validation error occurred, please check your input and then try again.&quot;, innerException) { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The message in the outer-validation above indicates that the issue is in the input, and therefore it requires the input submitter to try again as there are no actions required from the system side to be adjusted.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="213121-implementing-structural-validations">2.1.3.1.2.1 Implementing Structural Validations<a class="hash-link" href="#213121-implementing-structural-validations" title="Direct link to heading">​</a></h5><p>Now, let&#x27;s look at the other side of the validation process, which is the implementation.
Structural validations always come before each and every other type of validations. That&#x27;s simply because structural validations are the cheapest from an execution and asymptotic time perspective.
For instance, It&#x27;s much cheaper to validation an <code>Id</code> is invalid structurally, than sending an API call across to get the exact same answer plus the cost of latency. This all adds up when multi-million requests per second start flowing in.
Structural and logical validations in general live in their own partial class to run these validations, for instance, if our service is called <code>StudentService.cs</code> then a new file should be created with the name <code>StudentService.Validations.cs</code> to encapsulate and visually abstract away the validation rules to ensure clean data are coming in and going out.
Here&#x27;s how an Id validation would look like:</p><h6 class="anchor anchorWithStickyNavbar_LWe7" id="studentservicevalidationscs">StudentService.Validations.cs<a class="hash-link" href="#studentservicevalidationscs" title="Direct link to heading">​</a></h6><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void ValidateStudent(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Validate((Rule: IsInvalid(student.Id), Parameter: nameof(Student.Id)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static dynamic IsInvalid(Guid id) =&gt; new</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Condition = id == Guid.Empty,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Message = &quot;Id is required&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void Validate(params (dynamic Rule, string Parameter)[] validations)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var invalidStudentException = new InvalidStudentException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    foreach((dynamic rule, string parameter) in validations)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(rule.Condition)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            invalidStudentException.UpsertData(parameter, rule.Message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    invalidStudentException.ThrowIfContainsErrors();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We have implemented a method to validate the entire student object, with a compilation of all the rules we need to setup to validate structurally and logically the student input object. The most important part to notice about the above code snippet is to ensure the encapsulation of any finer details further away from the main goal of a particular method.</p><p>That&#x27;s the reason why we decided to implement a private static method <code>IsInvalid</code> to abstract away the details of what determines a property of type <code>Guid</code> is invalid or not. And as we move further in the implementation, we are going to have to implement multiple overloads of the same method to validate other value types structurally and logically.</p><p>The purpose of the <code>ValidateStudent</code> method is to simply set up the rules and take an action by throwing an exception if any of these rules are violated. There&#x27;s always an opportunity to aggregate the violation errors rather than throwing too early at the first sign of structural or logical validation issue to be detected.</p><p>Now, with the implementation above, we need to call that method to structurally and logically validate our input. Let&#x27;s make that call in our <code>RegisterStudentAsync</code> method as follows:</p><h6 class="anchor anchorWithStickyNavbar_LWe7" id="studentservicecs">StudentService.cs<a class="hash-link" href="#studentservicecs" title="Direct link to heading">​</a></h6><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public ValueTask&lt;Student&gt; RegisterStudentAsync(Student student) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TryCatch(async () =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValidateStudent(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.storageBroker.InsertStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At a glance, you will notice that our method here doesn&#x27;t necessarily handle any type of exceptions at the logic level. That&#x27;s because all the exception noise is also abstracted away in a method called <code>TryCatch</code>.</p><p><code>TryCatch</code> is a concept I invented to allow engineers to focus on what matters that most based on which aspect of the service that are looking at without having to take any shortcuts with the exception handling to make the code a bit more readable.</p><p><code>TryCatch</code> methods in general live in another partial class, and an entirely new file called <code>StudentService.Exceptions.cs</code> - which is where all exception handling and error reporting happens as I will show you in the following example.</p><p>Let&#x27;s take a look at what a <code>TryCatch</code> method looks like:</p><h6 class="anchor anchorWithStickyNavbar_LWe7" id="studentserviceexceptionscs">StudentService.Exceptions.cs<a class="hash-link" href="#studentserviceexceptionscs" title="Direct link to heading">​</a></h6><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private delegate ValueTask&lt;Student&gt; ReturningStudentFunction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private async ValueTask&lt;Student&gt; TryCatch(ReturningStudentFunction returningStudentFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return await returningStudentFunction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (InvalidStudentException invalidStudentInputException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw CreateAndLogValidationException(invalidStudentInputException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private StudentValidationException CreateAndLogValidationException(Exception exception)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var studentValidationException = new StudentValidationException(exception);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBroker.LogError(studentValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return studentValidationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>TryCatch</code> exception noise-cancellation pattern beautifully takes in any function that returns a particular type as a delegate and handles any thrown exceptions off of that function or it&#x27;s dependencies.</p><p>The main responsibility of a <code>TryCatch</code> function is to wrap up a service inner exceptions with outer exceptions to ease-up the reaction of external consumers of that service into only one of the three categories, which are Service Exceptions, Validations Exceptions and Dependency Exceptions. there are sub-types to these exceptions such as Dependency Validation Exceptions but these usually fall under the Validation Exception category as we will discuss in upcoming sections of The Standard.</p><p>In a <code>TryCatch</code> method, we can add as many inner and external exceptions as we want and map them into local exceptions for upstream services not to have a strong dependency on any particular libraries or external resource models, which we will talk about in detail when we move on to the Mapping responsibility of broker-neighboring (foundation) services.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21313-logical-validations">2.1.3.1.3 Logical Validations<a class="hash-link" href="#21313-logical-validations" title="Direct link to heading">​</a></h4><p>Logical validations are the second in order to structural validations. their main responsibility by definition is to logically validate whether a structurally valid piece of data is logically valid.
For instance, a date of birth for a student could be structurally valid by having a value of <code>1/1/1800</code> but logically, a student that is over 200 years of age is an impossibility.</p><p>The most common logical validations are validations for audit fields such as <code>CreatedBy</code> and <code>UpdatedBy</code> - it&#x27;s logically impossible that a new record can be inserted with two different values for the authors of that new record - simply because data can only be inserted by one person at a time.</p><p>Let&#x27;s talk about how we can test-drive and implement logical validations:</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="213130-testing-logical-validations">2.1.3.1.3.0 Testing Logical Validations<a class="hash-link" href="#213130-testing-logical-validations" title="Direct link to heading">​</a></h5><p>In the common case of testing logical validations for audit fields, we want to throw a validation exception that the <code>UpdatedBy</code> value is invalid simply because it doesn&#x27;t match the <code>CreatedBy</code> field.</p><p>Let&#x27;s assume our Student model looks as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Student {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Guid CreatedBy {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Guid UpdatedBy {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Our test to validate these values logically would be as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Fact]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public async Task ShouldThrowValidationExceptionOnRegisterIfUpdatedByNotSameAsCreatedByAndLogItAsync()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // given</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student randomStudent = CreateRandomStudent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student inputStudent = randomStudent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inputStudent.UpdatedBy = Guid.NewGuid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var invalidStudentException = new InvalidStudentException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    invalidStudentException.AddData(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        key: nameof(Student.UpdatedBy),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        value: $&quot;Id is not the same as {nameof(Student.CreatedBy)}.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var expectedStudentValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new StudentValidationException(invalidStudentException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValueTask&lt;Student&gt; registerStudentTask =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.studentService.RegisterStudentAsync(inputStudent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StudentValidationException actualStudentValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await Assert.ThrowsAsync&lt;StudentValidationException&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerStudentTask.AsTask);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actualStudentValidationException.Should().BeEquivalentTo(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expectedStudentValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.Verify(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.LogError(It.Is(SameExceptionAs(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expectedStudentValidationException))),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.Verify(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.InsertStudentAsync(It.IsAny&lt;Student&gt;()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Times.Never);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.dateTimeBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above test, we have changed the value of the <code>UpdatedBy</code> field to ensure it completely differs from the <code>CreatedBy</code> field - now we expect an <code>InvalidStudentException</code> with the <code>CreatedBy</code> to be the reason for this validation exception to occur.</p><p>Let&#x27;s go ahead an write an implementation for this failing test.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="213131-implementing-logical-validations">2.1.3.1.3.1 Implementing Logical Validations<a class="hash-link" href="#213131-implementing-logical-validations" title="Direct link to heading">​</a></h5><p>Just like we did in the structural validations section, we are going to add more rules to our validation <code>switch case</code> as follows:</p><h6 class="anchor anchorWithStickyNavbar_LWe7" id="studentservicevalidationscs-1">StudentService.Validations.cs<a class="hash-link" href="#studentservicevalidationscs-1" title="Direct link to heading">​</a></h6><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private void ValidateStudent(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Validate(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (Rule: IsNotSame(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            firstId: student.UpdatedBy,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            secondId: student.CreatedBy,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            secondIdName: nameof(student.CreatedBy)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Parameter: nameof(Student.UpdatedBy))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private static dynamic IsNotSame(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Guid firstId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Guid secondId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string secondIdName) =&gt; new</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Condition = firstId != secondId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message = $&quot;Id is not the same as {secondIdName}.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void Validate(params (dyanamic Rule, string Parameter)[] validations)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var invalidStudentException = new Exception();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    foreach((dynamic rule, string parameter) in validations)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(rule.Condition)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            invalidStudentException.UpsertData(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                key: parameter,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                value: rule.Message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Everything else in both <code>StudentService.cs</code> and <code>StudentService.Exceptions.cs</code> continues to be exactly the same as we&#x27;ve done above in the structural validations.</p><p>Logical validations exceptions, just like any other exceptions that may occur are usually non-critical. However, it all depends on your business case to determine whether a particular logical, structural or even a dependency validation are critical or not, this is when you might need to create a special class of exceptions, something like <code>InvalidStudentCriticalException</code> then log it accordingly.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21314-external-validations">2.1.3.1.4 External Validations<a class="hash-link" href="#21314-external-validations" title="Direct link to heading">​</a></h4><p>The last type of validations that are usually performed by foundation services is external validations. I define external validations as any form of validation that requires calling an external resource to validate whether a foundation service should proceed with processing incoming data or halt with an exception.</p><p>A good example of dependency validations is when we call a broker to retrieve a particular entity by it&#x27;s id. If the entity returned is not found, or the API broker returns a <code>NotFound</code> error - the foundation service is then required to wrap that error in a <code>ValidationException</code> and halts all following processes.</p><p>External validation exceptions can occur if the returned value did not match the expectation, such as an empty list returned from an API call when trying to insert a new coach of a team - if there is no team members, there can be no coach for instance. The foundation service in this case will be required to raise a local exception to explain the issue, something like <code>NoTeamMembersFoundException</code> or something of that nature.</p><p>Let&#x27;s write a failing test for an external validation example:</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="213140-testing-external-validations">2.1.3.1.4.0 Testing External Validations<a class="hash-link" href="#213140-testing-external-validations" title="Direct link to heading">​</a></h5><p>Let&#x27;s assume we are trying to retrieve a student with an <code>Id</code> that doesn&#x27;t match any records in the database. Here&#x27;s how we would go about testing this scenario. First off, let&#x27;s define a <code>NotFoundStudentException</code> model as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">using Xeption;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NotFoundStudentException : Xeption</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NotFoundStudentException(Guid id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        : base (message: $&quot;Couldn&#x27;t find a student with id: {id}.&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above model is the localization aspect of handling the issue. Now let&#x27;s write a failing test as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async Task ShouldThrowValidationExceptionOnRetrieveByIdIfStudentNotFoundAndLogItAsync()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // given</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Guid randomStudentId = Guid.NewGuid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Guid inputStudentId = randomStudentId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student noStudent = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var notFoundStudentException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new NotFoundStudentException(inputStudentId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var expectedStudentValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new StudentValidationException(notFoundStudentException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.Setup(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.SelectStudentByIdAsync(inputStudentId))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ReturnsAsync(noStudent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValueTask&lt;Student&gt; retrieveStudentByIdTask =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.studentService.RetrieveStudentByIdAsync(inputStudentId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StudentValidationException actualStudentValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await Assert.ThrowsAsync&lt;StudentValidationException&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            retrieveStudentByIdTask.AsTask);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actualStudentValidationException.Should().BeEquivalentTo(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expectedStudentValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.Verify(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.SelectStudentByIdAsync(inputStudentId),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.Verify(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.LogError(It.Is(SameExceptionAs(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expectedStudentValidationException))),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.dateTimeBrokerMock.VerifyNotOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The test above requires us to throw a localized exception as in <code>NotFoundStudentException</code> when the storage broker returns no values for the given <code>studentId</code> and then wrap or categorize this up in <code>StudentValidationException</code>.</p><p>We choose to wrap the localized exception in a validation exception and not in a dependency validation exception because the initiation of the error originated from our service not from the external resource. If the external resource is the source of the error we would have to categorize this as a <code>DependencyValidationException</code> which we will discuss shortly.</p><p>Now let&#x27;s get to the implementation part of this section to make our test pass.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="213141-implementing-external-validations">2.1.3.1.4.1 Implementing External Validations<a class="hash-link" href="#213141-implementing-external-validations" title="Direct link to heading">​</a></h5><p>In order to implement an external validation we will need to touch on all different aspects of our service. The core logic, the validation and the exception handling aspects are as follows.</p><p>First off, let&#x27;s build a validation function that will throw a <code>NotFoundStudentException</code> if the passed-in parameter is null.</p><h6 class="anchor anchorWithStickyNavbar_LWe7" id="studentservicevalidationscs-2">StudentService.Validations.cs<a class="hash-link" href="#studentservicevalidationscs-2" title="Direct link to heading">​</a></h6><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static void VerifyStudentExists(Student maybeStudent, Guid studentId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (maybeStudent is null)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new NotFoundStudentException(studentId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This implementation will take care of detecting an issue and issuing a local exception <code>NotFoundStudentException</code>. Now let&#x27;s jump over to the exception handling aspect of our service.</p><h6 class="anchor anchorWithStickyNavbar_LWe7" id="studentserviceexceptionscs-1">StudentService.Exceptions.cs<a class="hash-link" href="#studentserviceexceptionscs-1" title="Direct link to heading">​</a></h6><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private async ValueTask&lt;Student&gt; TryCatch(ReturningStudentFunction returningStudentFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return await returningStudentFunction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ..</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (NotFoundStudentException notFoundStudentException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw CreateAndLogValidationException(notFoundStudentException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private StudentValidationException CreateAndLogValidationException(Exception exception)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var studentValidationException = new StudentValidationException(exception);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBroker.LogError(studentValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return studentValidationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above implementation will take care of categorizing a <code>NotFoundStudentException</code> to <code>StudentValidationException</code>. The last part is to put the pieces together as follows.</p><h6 class="anchor anchorWithStickyNavbar_LWe7" id="studentservicecs-1">StudentService.cs<a class="hash-link" href="#studentservicecs-1" title="Direct link to heading">​</a></h6><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public ValueTask&lt;Student&gt; RetrieveStudentByIdAsync(Guid studentId) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TryCatch(async () =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValidateStudentId(studentId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student maybeStudent =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await this.storageBroker.SelectStudentByIdAsync(studentId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValidateStudentExists(maybeStudent, studentId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return maybeStudent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above implementation will ensure that the id is valid, but more importantly that whatever the <code>storageBroker</code> returns will be checked for whether it&#x27;s an object or <code>null</code>. Then issue the exception.</p><p>There are situations where attempting to retrieve an entity then finding out that it doesn&#x27;t exist is not necessarily erroneous. This is where Processing Services come in to leverage a higher-order business logic to deal with this more complex scenario.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21315-dependency-validations">2.1.3.1.5 Dependency Validations<a class="hash-link" href="#21315-dependency-validations" title="Direct link to heading">​</a></h4><p>Dependency validation exceptions can occur because you called an external resource and it returned an error, or returned a value that warrants raising an error. For instance, an API call might return a <code>404</code> code, and that&#x27;s interpreted as an exception if the input was supposed to correspond to an existing object.</p><p>A more common example is when a particular input entity is using the same id as an existing entity in the system. In a relational database world, a duplicate key exception would be thrown. In a RESTful API scneario, programmatically applying the same concept also achieves the same goal for API validations assuming the granularity of the system being called weaken the referential integrity of the overall system data.</p><p>There are situations where the faulty response can be expressed in a fashion other than exceptions, but we shall touch on that topic in a more advanced chapters of this Standard.</p><p>Let&#x27;s write a failing test to verify whether we are throwing a <code>DependencyValidationException</code> if <code>Student</code> model already exists in the storage with the storage broker throwing a <code>DuplicateKeyException</code> as a native result of the operation.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="213150-testing-dependency-validations">2.1.3.1.5.0 Testing Dependency Validations<a class="hash-link" href="#213150-testing-dependency-validations" title="Direct link to heading">​</a></h5><p>Let&#x27;s assume our student model uses an <code>Id</code> with the type <code>Guid</code> as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Student</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Guid Id {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string Name {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>our unit test to validate a <code>DependencyValidation</code> exception would be thrown in a <code>DuplicateKey</code> situation would be as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Fact]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public async void ShouldThrowDependencyValidationExceptionOnRegisterIfStudentAlreadyExistsAndLogItAsync()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // given</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student someStudent = CreateRandomStudent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string someMessage = GetRandomMessage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var duplicateKeyException = new DuplicateKeyException(exceptionMessage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var alreadyExistsStudentException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new AlreadyExistsStudentException(duplicateKeyException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var expectedStudentDependencyValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new StudentDependencyValidationException(alreadyExistsStudentException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.Setup(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.InsertStudentAsync(It.IsAny&lt;Student&gt;()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ThrowsAsync(duplicateKeyException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValueTask&lt;Student&gt; registerStudentTask =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.studentService.RegisterStudentAsync(inputStudent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StudentDependencyValidationException actualStudentDependencyValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await Assert.ThrowsAsync&lt;StudentDependencyValidationException&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            registerStudentTask.AsTask);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actualStudentDependencyValidationException.Should().BeEquivalentTo(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expectedStudentDependencyValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.Verify(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.InsertStudentAsync(It.IsAny&lt;Student&gt;()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.Verify(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.LogError(It.Is(SameExceptionAs(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expectedStudentDependencyValidationException))),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.storageBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above test, we validate that we wrap a native <code>DuplicateKeyException</code> in a local model tailored to the specific model case which is the <code>AlreadyExistsStudentException</code> in our example here. then we wrap that again with a generic category exception model which is the <code>StudentDependencyValidationException</code>.</p><p>There&#x27;s a couple of rules that govern the construction of dependency validations, which are as follows:</p><ul><li>Rule 1: If a dependency validation is handling another dependency validation from a downstream service, then the inner exception of the downstream exception should be the same for the dependency validation at the current level.</li></ul><p>In other words, if some <code>StudentService</code> is throwing a <code>StudentDependencyValidationException</code> to an upstream service such as <code>StudentProcessingService</code> - then it&#x27;s important that the <code>StudentProcessingDependencyValidationException</code> contain the same inner exception as the <code>StudentDependencyValidationException</code>. That&#x27;s because once these exception are mapped into exposure components, such as API controller or UI components, the original validation message needs to propagate through the system and be presented to the end user no matter where it originated from.</p><p>Additionally, maintaining the original inner exception guarantees the ability to communicate different error messages through API endpoints. For instance, <code>AlreadyExistsStudentException</code> can be communicated as <code>Conflict</code> or <code>409</code> on an API controller level - this differs from another dependency validation exception such as <code>InvalidStudentReferenceException</code> which would be communicated as <code>FailedDependency</code> error or <code>424</code>.</p><ul><li>Rule 2: If a dependency validation exception is handling a non-dependency validation exception it should take that exception as it&#x27;s inner exception and not anything else.</li></ul><p>These rules ensures that only the local validation exception is what&#x27;s being propagated not it&#x27;s native exception from a storage system or an API or any other external dependency.</p><p>Which is the case that we have here with our <code>AlreadyExistsStudentException</code> and it&#x27;s <code>StudentDependencyValidationException</code> - the native exception is completely hidden away from sight, and the mapping of that native exception and it&#x27;s inner message is what&#x27;s being communicated to the end user. This gives the engineers the power to control what&#x27;s being communicated from the other end of their system instead of letting the native message (which is subject to change) propagate to the end-users.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="213051-implementing-dependency-validations">2.1.3.0.5.1 Implementing Dependency Validations<a class="hash-link" href="#213051-implementing-dependency-validations" title="Direct link to heading">​</a></h5><p>Depending on where the validation error originates from, the implementation of dependency validations may or may not contain any business logic. As we previously mentioned, if the error is originating from the external resource (which is the case here) - then all we have to do is just wrap that error in a local exception then categorize it with an external exception under dependency validation.</p><p>To ensure the aforementioned test passed, we are going to need few models.
For the <code>AlreadyExistsStudentException</code> the implementation would be as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class AlreadyExistsStudentException : Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AlreadyExistsStudentException(Exception innerException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        : base($&quot;Student with the same Id already exists&quot;, innerException){ }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We also need the <code>StudentDependencyValidationException</code> which should be as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class StudentDependencyValidationException : Exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public StudentDependencyValidationException(Exception innerException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        : base($&quot;Student dependency validation error occurred, please try again.&quot;, innerException){ }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, let&#x27;s go to the implementation side, let&#x27;s start with the exception handling logic:</p><h6 class="anchor anchorWithStickyNavbar_LWe7" id="studentserviceexceptionscs-2">StudentService.Exceptions.cs<a class="hash-link" href="#studentserviceexceptionscs-2" title="Direct link to heading">​</a></h6><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private delegate ValueTask&lt;Student&gt; ReturningStudentFunction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private async ValueTask&lt;Student&gt; TryCatch(ReturningStudentFunction returningStudentFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return await returningStudentFunction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    catch (DuplicateKeyException duplicateKeyException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var alreadyExistsStudentException = new AlreadyExistsStudentException(duplicateKeyException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw CreateAndLogDependencyValidationException(alreadyExistsStudentException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private StudentDependencyValidationException CreateAndLogDependencyValidationException(Exception exception)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var studentDependencyValidationException = new StudentDependencyValidationException(exception);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBroker.LogError(studentDependencyValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return studentDependencyValidationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We created the local inner exception in the catch block of our exception handling process to allow the reusability of our dependency validation exception method for other situations that require that same level of external exceptions.</p><p>Everything else stays the same for the referencing of the <code>TryCatch</code> method in the <code>StudentService.cs</code> file.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2132-mapping">2.1.3.2 Mapping<a class="hash-link" href="#2132-mapping" title="Direct link to heading">​</a></h3><p>The second responsibility for a foundation service is to play the role of a mapper both ways between local models and non-local models. For instance, if you are leveraging an email service that provides it&#x27;s own SDKs to integrate with, and your brokers are already wrapping and exposing the APIs for that service, your foundation service is required to map the inputs and outputs of the broker methods into local models. the same situation and more commonly between native non-local exceptions such as the ones we mentioned above with the dependency validation situation, the same aspect applies to just dependency errors or service errors as we will discuss shortly.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21320-non-local-models">2.1.3.2.0 Non-Local Models<a class="hash-link" href="#21320-non-local-models" title="Direct link to heading">​</a></h4><p>Its very common for modern applications to require integration at some point with external services. these services can be local to the overall architecture or distributed system where the application lives, or it can be a 3rd party provider such as some of the popular email services for instance.
External services providers invest a lot of effort in developing fluent APIs, SDKs and libraries in every common programming language to make it easy for the engineers to integrate their applications with that 3rd party service. For instance, let&#x27;s assume a third party email service provider is offering the following API through their SDKs:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface IEmailServiceProvider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValueTask&lt;EmailMessage&gt; SendEmailAsync(EmailMessage message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Let&#x27;s consider the model <code>EmailMessage</code> is a native model, it comes with the email service provider SDK. your brokers might offer a wrapper around this API by building a contract to abstract away the <em>functionality</em> but can&#x27;t do much with the native models that are passed in or returned out of these functionality. therefore our brokers interface would look something like this:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface IEmailBroker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValueTask&lt;EmailMessage&gt; SendEmailMessageAsync(EmailMessage message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then the implementation would something like this:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class EmailBroker : IEmailBroker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async ValueTask&lt;EmailMessage&gt; SendEmailMessageAsync(EmailMessage message) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await this.emailServiceProvider.SendEmailAsync(message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As we said before, the brokers here have done their part of abstraction by pushing away the actual implementation and the dependencies of the native <code>EmailServiceProvider</code> away from our foundation serviecs. But that&#x27;s only 50% of the job, the abstraction isn&#x27;t quite fully complete yet until there are no tracks of the native <code>EmailMessage</code> model. This is where the foundation services come in to do a test-driven operation of mapping between the native non-local models and your application&#x27;s local models. therefore its very possible to see a mapping function in a foundation service to abstract away the native model from the rest of your business layer services.</p><p>Your foundation service then will be required to support a new local model, let&#x27;s call it <code>Email</code>. your local model&#x27;s property may be identical to the external model <code>EmailMessage</code> - especially on a primitive data type level. But the new model would be the one and only contract between your pure business logic layer (processing, orchestration, coordination and management services) and your hybrid logic layer like the foundation services. Here&#x27;s a code snippet for this operation:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;Email&gt; SendEmailMessageAsync(Email email)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EmailMessage inputEmailMessage = MapToEmailMessage(email);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EmailMessage sentEmailMessage = await this.emailBroker.SendEmailMessageAsync(inputEmailMessage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return MapToEmail(sentEmailMessage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Depending on whether the returned message has a status or you would like to return the input message as a sign of a successful operation, both practices are valid in my Standard. It all depends on what makes more sense to the operation you are trying to execute. the code snippet above is an ideal scenario where your code will try to stay true to the value passed in as well as the value returned with all the necessary mapping included.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="21321-exceptions-mappings">2.1.3.2.1 Exceptions Mappings<a class="hash-link" href="#21321-exceptions-mappings" title="Direct link to heading">​</a></h4><p>Just like the non-local models, exceptions that are either produced by the external API like the EntityFramework models <code>DbUpdateException</code> or any other has to be mapped into local exception models.
Handling these non-local exceptions that early before entering the pure-business layer components will prevent any potential tight coupling or dependency on any external model. as it may be very common, that exceptions can be handled differently based on the type of exception and how we want to deal with it internally in the system.
For instance, if we are trying to handle a <code>UserNotFoundException</code> being thrown from using Microsoft Graph for instance, we might not necessarily want to exit the entire procedure. we might want to continue by adding a user in some other storage for future Graph submittal processing.
External APIs should not influence whether your internal operation should halt or not. and therefore handling exceptions on the Foundation layer is the guarantee that this influence is limited within the borders of our external resources handling area of our application and has no impact whatsoever on our core business processes.
The following illustration should draw the picture a bit clearer from that perspective:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/112714067-b7366a00-8e95-11eb-9bb7-a5a047640f4a.png" class="img_ev3q"></p><br><p>Here&#x27;s some common scenarios for mapping native or inner local exceptions to outer exceptions:</p><table><thead><tr><th>Exception</th><th>Wrap Inner Exception With</th><th>Wrap With</th><th>Log Level</th></tr></thead><tbody><tr><td>NullStudentException</td><td>-</td><td>StudentValidationException</td><td>Error</td></tr><tr><td>InvalidStudentException</td><td>-</td><td>StudentValidationException</td><td>Error</td></tr><tr><td>SqlException</td><td>FailedStudentStorageException</td><td>StudentDependencyException</td><td>Critical</td></tr><tr><td>HttpResponseUrlNotFoundException</td><td>FailedStudentApiException</td><td>StudentDependencyException</td><td>Critical</td></tr><tr><td>HttpResponseUnauthorizedException</td><td>FailedStudentApiException</td><td>StudentDependencyException</td><td>Critical</td></tr><tr><td>NotFoundStudentException</td><td>-</td><td>StudentValidationException</td><td>Error</td></tr><tr><td>HttpResponseNotFoundException</td><td>NotFoundStudentException</td><td>StudentDependencyValidationException</td><td>Error</td></tr><tr><td>DuplicateKeyException</td><td>AlreadyExistsStudentException</td><td>StudentDependencyValidationException</td><td>Error</td></tr><tr><td>HttpResponseConflictException</td><td>AlreadyExistsStudentException</td><td>StudentDependencyValidationException</td><td>Error</td></tr><tr><td>ForeignKeyConstraintConflictException</td><td>InvalidStudentReferenceException</td><td>StudentDependencyValidationException</td><td>Error</td></tr><tr><td>DbUpdateConcurrencyException</td><td>LockedStudentException</td><td>StudentDependencyValidationException</td><td>Error</td></tr><tr><td>DbUpdateException</td><td>FailedStudentStorageException</td><td>StudentDependencyException</td><td>Error</td></tr><tr><td>HttpResponseException</td><td>FailedStudentApiException</td><td>StudentDependencyException</td><td>Error</td></tr><tr><td>Exception</td><td>FailedStudentServiceException</td><td>StudentServiceException</td><td>Error</td></tr></tbody></table><p>[*][Standardizing Validations &amp; Exceptions]<!-- -->(<a href="https://www.youtube.com/watch?v=Wtpxb7yPQP0" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=Wtpxb7yPQP0</a>)</p><p>[*][Test-Driving Non-Circuit-Breaking Validations]<!-- -->(<a href="https://www.youtube.com/watch?v=guJPrIQ0kJk" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=guJPrIQ0kJk</a>)</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/2. Services/2.1 Foundations/2.1 Foundations.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/The-Standard/docs/Services/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">2 Services</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/The-Standard/docs/Services/2.2 Processings/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">2.2 Processing Services (Higher-Order Business Logic)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#210-introduction" class="table-of-contents__link toc-highlight">2.1.0 Introduction</a></li><li><a href="#211-on-the-map" class="table-of-contents__link toc-highlight">2.1.1 On The Map</a></li><li><a href="#212-characteristics" class="table-of-contents__link toc-highlight">2.1.2 Characteristics</a><ul><li><a href="#2120-pure-primitive" class="table-of-contents__link toc-highlight">2.1.2.0 Pure-Primitive</a></li><li><a href="#2121-single-entity-integration" class="table-of-contents__link toc-highlight">2.1.2.1 Single Entity Integration</a></li><li><a href="#2122-business-language" class="table-of-contents__link toc-highlight">2.1.2.2 Business Language</a></li></ul></li><li><a href="#213-responsibilities" class="table-of-contents__link toc-highlight">2.1.3 Responsibilities</a><ul><li><a href="#2130-abstraction" class="table-of-contents__link toc-highlight">2.1.3.0 Abstraction</a></li><li><a href="#2131-validation" class="table-of-contents__link toc-highlight">2.1.3.1 Validation</a></li><li><a href="#2132-mapping" class="table-of-contents__link toc-highlight">2.1.3.2 Mapping</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/The-Standard/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/The-Standard/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/The-Standard/assets/js/runtime~main.06584d35.js"></script>
<script src="/The-Standard/assets/js/main.1bcd0719.js"></script>
</body>
</html>