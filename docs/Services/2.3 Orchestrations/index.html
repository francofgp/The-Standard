<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-Services/2.3 Orchestrations/2.3 Orchestrations">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-rc.1">
<link rel="alternate" type="application/rss+xml" href="/The-Standard/blog/rss.xml" title="The Standard ❤️ RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/The-Standard/blog/atom.xml" title="The Standard ❤️ Atom Feed"><title data-rh="true">2.3 Orchestration Services (Complex Higher Order Logic) | The Standard ❤️</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://francofgp.github.io/The-Standard/docs/Services/2.3 Orchestrations/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="2.3 Orchestration Services (Complex Higher Order Logic) | The Standard ❤️"><meta data-rh="true" name="description" content="2.3.0 Introduction"><meta data-rh="true" property="og:description" content="2.3.0 Introduction"><link data-rh="true" rel="icon" href="/The-Standard/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://francofgp.github.io/The-Standard/docs/Services/2.3 Orchestrations/"><link data-rh="true" rel="alternate" href="https://francofgp.github.io/The-Standard/docs/Services/2.3 Orchestrations/" hreflang="en"><link data-rh="true" rel="alternate" href="https://francofgp.github.io/The-Standard/docs/Services/2.3 Orchestrations/" hreflang="x-default"><link rel="stylesheet" href="/The-Standard/assets/css/styles.95b304a2.css">
<link rel="preload" href="/The-Standard/assets/js/runtime~main.06584d35.js" as="script">
<link rel="preload" href="/The-Standard/assets/js/main.1bcd0719.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/The-Standard/"><div class="navbar__logo"><img src="/The-Standard/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/The-Standard/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">The Standard</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/The-Standard/docs/intro">Docs</a><a class="navbar__item navbar__link" href="/The-Standard/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/The-Standard/docs/Introduction/">0 Introduction</a><button aria-label="Toggle the collapsible sidebar category &#x27;0 Introduction&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/The-Standard/docs/Brokers/">1 Brokers</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/The-Standard/docs/Services/">2 Services</a><button aria-label="Toggle the collapsible sidebar category &#x27;2 Services&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/The-Standard/docs/Services/2.1 Foundations/">2.1 Foundation Services (Broker-Neighboring)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/The-Standard/docs/Services/2.2 Processings/">2.2 Processing Services (Higher-Order Business Logic)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/The-Standard/docs/Services/2.3 Orchestrations/">2.3 Orchestration Services (Complex Higher Order Logic)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/The-Standard/docs/Services/2.4 Aggregations/">2.4 Aggregation Services (The Knot)</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/The-Standard/docs/Exposers/">3 Exposers</a><button aria-label="Toggle the collapsible sidebar category &#x27;3 Exposers&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/The-Standard/docs/intro">The Standard (v 2.0.1)</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/The-Standard/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/The-Standard/docs/Services/"><span itemprop="name">2 Services</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">2.3 Orchestration Services (Complex Higher Order Logic)</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>2.3 Orchestration Services (Complex Higher Order Logic)</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="230-introduction">2.3.0 Introduction<a class="hash-link" href="#230-introduction" title="Direct link to heading">​</a></h2><p>Orchestration services are the combinators between multiple foundation or processing services to perform a complex logical operation. Orchestrations main responsibility is to do a multi-entity logical operation and delegate the dependencies of said operation to downstream processing or foundation services.
Orchestration services main responsibility is to encapsulate operations that require two or three business entities.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;LibraryCard&gt; CreateStudentLibraryCardAsync(LibraryCard libraryCard) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TryCatch(async () =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValidateLibraryCard(libraryCard);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await this.studentProcessingService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .VerifyEnrolledStudentExistsAsync(libraryCard.StudentId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.libraryCardProcessingService.CreateLibraryCardAsync(libraryCard);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above example, the <code>LibraryCardOrchestrationService</code> calls both the <code>StudentProcessingService</code> and <code>LibraryCardProcessingService</code> to perform a complex operation. First, verify the student we are creating a library card for does exist and that they are enrolled. Then second create the library card.</p><p>The operation of creating a library card for any given student cannot be performed by simply calling the library card service. That&#x27;s because the library card service (processing or foundation) does not have access to all the details about the student. Therefore a combination logic here needed to be implemented to ensure a proper flow is in place.</p><p>Its important to understand that orchestration services are only required if and only if we need to combine multiple entities operations primitive or higher-order. In some architectures, orchestration services might not even exist. That&#x27;s simply because some microservices might be simply responsible for applying validation logic and persisting and retrieving data from storage, no more or no less.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="231-on-the-map">2.3.1 On The Map<a class="hash-link" href="#231-on-the-map" title="Direct link to heading">​</a></h2><p>Orchestration services are one of the core business logic components in any system. They are positioned between single entity services (such as processing or foundation) and advanced logic services such as coordination services, aggregation services or just simply exposers such as controllers, web components or anything else. Here&#x27;s a high level overview of where orchestration services may live:</p><br><p align="center"><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/118414675-e4fc8b80-b65a-11eb-91c8-94f67c6e68ed.png" class="img_ev3q"></p><br><p>As shown above, orchestration services have quite a few dependencies and consumers. They are the core engine of any software. On the right hand side, you can see the dependencies an orchestration service may have. Since a processing service is optional based on whether a higher-order business logic is needed or not - orchestration services can combine multiple foundation services as well.</p><p>The existence of an orchestration service warrants the existence of a processing service. But thats not always the case. There are situations where all orchestration services need to finalize a business flow is to interact with primitive-level functionality.</p><p>From a consumer standpoint however, orchestration service could have several consumers. These consumers could range from coordination services (orchestrators of orchestrators) or aggregation services or simply an exposer. Exposers are like controllers, view service, UI components or simply another foundation or processing service in case of putting messages back on a queue - which we will discuss further in our Standard.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="232-characteristics">2.3.2 Characteristics<a class="hash-link" href="#232-characteristics" title="Direct link to heading">​</a></h2><p>In general, orchestration services are concerned with combining single-entity primitive or higher-order business logic operations to execute a successful flow. But you can also think of them as the glue that ties multiple single-entity operations together.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2320-language">2.3.2.0 Language<a class="hash-link" href="#2320-language" title="Direct link to heading">​</a></h3><p>Just like processing services, the language used in orchestration services define the level of complexity and the capabilities it offers.
Usually, orchestration services combine two or more primitive or higher-order operations from multiple single-entity services to execute a successful operation.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23200-functions-language">2.3.2.0.0 Functions Language<a class="hash-link" href="#23200-functions-language" title="Direct link to heading">​</a></h4><p>Orchestration services have a very common charateristic when it comes to the language of it&#x27;s functions. Orchestration services are wholistic in most of the language of its function, you will see functions such as <code>NotifyAllAdmins</code> where the service pulls all users with admin type and then calls a notification service to notify each and every one of them.</p><p>It becomes very obvious that orchestration services offer functionality that inches closer and closer to a business language than perimitive technical operation. You may see almost an identical expression in a non-technical business requirement that matches one for one a function name in an orchestration service. The same pattern continues as one goes to higher and more advanced categories of services within that realm of business logic.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23201-pass-through">2.3.2.0.1 Pass-Through<a class="hash-link" href="#23201-pass-through" title="Direct link to heading">​</a></h4><p>Orchestration services can also be a pass-through for some operations. For instance, an orchestration service could allow an <code>AddStudentAsync</code> to be propagated through the service to unify the source of interactions with the system at the exposers level. In which case, orchestration services will use the very same terminology a processing or a foundation service may use to propagate the operation.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23202-class-level-language">2.3.2.0.2 Class-Level Language<a class="hash-link" href="#23202-class-level-language" title="Direct link to heading">​</a></h4><p>Orchestration services mainly combine multiple operations to support a particular entity. So, if the main entity of support is <code>Student</code> and the rest of the entities are just to support an operation mainly targetting a <code>Student</code> entity - then the name of the orchestration service would be <code>StudentOrchestrationService</code>.</p><p>This level of enforcement of naming conventions ensures that any orchestration service is staying focused on a single entity responsibility with respect to multiple other supporting entities.</p><p>For instance, if creating a library card requires ensuring the student referenced in that library card must be enrolled in a school. Then an orchestration service will then be named after it&#x27;s main entity which is <code>LibraryCard</code> in this case. Our orchestration service name then would be <code>LibraryCardOrchestrationService</code>.</p><p>The opposite is also true. If enrolling a student in a school has an accompanying operations such as creating a library card, then in this case a <code>StudentOrchestrationService</code> must be created with the main purpose to create a <code>Student</code> and then all other related entities once the aforementioned succeeds.</p><p>The same idea applies to all exceptions created in an orchestration service such as <code>StudentOrchestrationValidationException</code> and <code>StudentOrchestrationDependencyException</code> and so on.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2321-dependencies">2.3.2.1 Dependencies<a class="hash-link" href="#2321-dependencies" title="Direct link to heading">​</a></h3><p>As we mentioned above, orchestration services might have a bit larger range of types of dependencies unlike processing and foundation services. This is only due the optionality of processing services. Therefore, orchestration services may have dependencies that range from foundation services or processing services and optionally and usually logging or any other utility brokers.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23210-dependency-balance-florance-pattern">2.3.2.1.0 Dependency Balance (Florance Pattern)<a class="hash-link" href="#23210-dependency-balance-florance-pattern" title="Direct link to heading">​</a></h4><p>There&#x27;s a very important rule that govern the consistency and balance of orchestration services which is the &#x27;Florance Pattern&#x27;. the rule dictates that any orchestration service may not combine dependencies from different categories of operation.</p><p>What that means, is that an orchestration service cannot have a foundation and a processing services combined together. The dependencies has to be either all processings or all foundations. That rule doesn&#x27;t apply to utility brokers dependencies however.</p><p>Here&#x27;s an example of an unbalanced orchestration service dependencies:</p><br><p align="center"><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/118415856-9e5e5f80-b661-11eb-96db-a541f89ccee7.png" class="img_ev3q"></p><br><p>An additional processing service is required to give a pass-through to a lower-level foundation service to balance the architecture - applying &#x27;Florance Pattern&#x27; for symmetry would turn our architecture to the following:</p><br><p align="center"><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/118415965-33f9ef00-b662-11eb-8538-59e5c728d308.png" class="img_ev3q"></p><br><p>Applying &#x27;Florance Pattern&#x27; might be very costly at the beginning as it includes creating an entirely new processing service (or multiple) just to balance the architecture. But its benefits outweighs the effort spent from a maintainability, readability and pluggability perspectives.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23211-two-three">2.3.2.1.1 Two-Three<a class="hash-link" href="#23211-two-three" title="Direct link to heading">​</a></h4><p>The &#x27;Two-Three&#x27; rule is a complexity control rule. This rule dictates that an orchestration service may not have more than three or less than two processing or foundation services to run the orchestration. This rule, however, doesn&#x27;t apply to utility brokers. And orchestration service may have a <code>DateTimeBroker</code> or a <code>LoggingBroker</code> without any issues. But an orchestration service may not have an entity broker, such as a <code>StorageBroker</code> or a <code>QueueBroker</code> which feeds directly into the core business layer of any service.</p><p>The &#x27;Two-Three&#x27; rule may require a layer of normalization to the categorical business function that is required to be accomplished. Let&#x27;s talk about the different mechanisms of normalizing orchestration services.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="232110-full-normalization">2.3.2.1.1.0 Full-Normalization<a class="hash-link" href="#232110-full-normalization" title="Direct link to heading">​</a></h5><p>Often times, there are situations where the current architecture of any given orchestration service ends up with one orchestration service that has three dependencies. And a new entity processing or foundation service is required to complete an existing process.</p><p>For instance, let&#x27;s say we have a <code>StudentContactOrchestrationService</code> and that service has dependencies that provide primitive-level functionality for <code>Address</code>, <code>Email</code> and <code>Phone</code> for each student. Here&#x27;s a visualization of that state:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/120101834-f636a500-c0fc-11eb-968b-10ed9a60bac8.png" class="img_ev3q"></p><br><p>Now, a new requirement comes in to add a student <code>SocialMedia</code> to gather more contact information about how to reach a certain student. We can go into full-normalization mode simply by finding the common ground that equally splits the contact information entities. For instance, we can split regular contact information versus digital contact information as in <code>Address</code> and <code>Phone</code> versus <code>Email</code> and <code>SocialMedia</code>. this way we split four dependencies into two each for their own orchestration services as follows:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/120101983-c6d46800-c0fd-11eb-836a-496d191ef922.png" class="img_ev3q"></p><br><p>As you can see in the figure above, we modified the existing <code>StudentContactOrchestrationService</code> into <code>StudentRegularContactOrchestrationService</code>, then we removed one of its dependencies on the <code>EmailService</code>.</p><p>Additionally, we created a new <code>StudentDigitalContactOrchestrationService</code> to have two dependencies on the existing <code>EmailService</code> in addition to the new <code>SocialMediaService</code>. But now that the normalization is over, we need an advanced order business logic layer, like a coordination service to provide student contact information to upstream consumers.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="232111-semi-normalization">2.3.2.1.1.1 Semi-Normalization<a class="hash-link" href="#232111-semi-normalization" title="Direct link to heading">​</a></h5><p>Normalization isn&#x27;t always as straightforward as the example above. Especially in situations where a core entity has to exist before creating or writing in additional information towards related entities to that very entity.</p><p>For instance, let&#x27;s say we have a <code>StudentRegistrationOrchestrationService</code> which relies on <code>StudentProcessingService</code>, <code>LibraryCardProcessingService</code> and <code>BookProcessingService</code> as follows:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/120099527-c41f4600-c0f0-11eb-8702-1439f966d9dc.png" class="img_ev3q"></p><br><p>But now, we need a new service to handle students immunization records as <code>ImmunizationProcessingService</code>. We need all four services but we already have a <code>StudentRegistrationOrchestrationService</code> that has three dependencies. At this point a semi-normalization is required for the re-balancing of the architecture to honor the &#x27;Two-Three&#x27; rule and eventually to control the complexity.</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/120100296-ea46e500-c0f4-11eb-888a-ed6668e9ffdb.png" class="img_ev3q"></p><br><p>In this case here, a further normalization or a split is required to re-balance the architecture. We need to think conceptually about a common ground between the primitive entities in a student registration process. A student requirements contain identity, health and materials. We can, in this scenario combine <code>LibraryCard</code> and <code>Book</code> under the same orchestration service as books and libraries are somewhat related. So we have <code>StudentLibraryOrchestrationService</code> and for the other service we would have <code>StudentHealthOrchestrationService</code> as follows:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/120100597-68f05200-c0f6-11eb-9ccc-ae1c963f6de5.png" class="img_ev3q"></p><br><p>To complete the registration flow with a new model, a coordination service is required to pass-in an advanced business logic to combine all of these entities together. But more importantly, you will notice that each orchestration service now has a redundant dependency of <code>StudentProcessingService</code> to ensure no virtual dependency on any other orchestration service create or ensuring a student record exists.</p><p>Virtual dependencies are very tricky. it&#x27;s a hidden connection between two services of any category where one service implicitly assumes that a particular entity will be created and present. Virtual dependencies are very dangerous and threaten the true autonomy of any service. Detecting virtual dependencies at early stage in the design and development process could be a daunting but necessary task to ensure a clean Standardized architecture is in place.</p><p>Just like model changes as it may require migrations, and additional logic and validations, a new requirement for an entirely new additional entity might require a restructuring of an existing architecture or extending it to a new version, depending in which stage the system is receiving these new requirements.</p><p>It may be very enticing to just add an additional dependency to an existing orchestration service - but that&#x27;s where the system starts to diverge from &#x27;The Standard&#x27;. And that&#x27;s when the system starts off the road of being an unmaintainable legacy system. But more importantly, it&#x27;s when the engineers involved in designing and developing the system are challenged against their very principles and craftmanship.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="232112-no-normalization">2.3.2.1.1.2 No-Normalization<a class="hash-link" href="#232112-no-normalization" title="Direct link to heading">​</a></h5><p>There are scenarios where any level of normalization is a challenge to achieve. While I believe that everything, everywhere, somehow is connected. Sometimes it might be incomprehensible for the mind to group multiple services together under one orchestration service.</p><p>Because it&#x27;s quite hard for my mind to come up with an example for multiple entities that have no connection to each other, as I truly believe it couldn&#x27;t exist. I&#x27;m going to rely on some fictional entities to visualize a problem. So let&#x27;s assume there are <code>AService</code> and <code>BService</code> orchestrated together with an <code>XService</code>. The existence of <code>XService</code> is important to ensure that both <code>A</code> and <code>B</code> can be created with an assurance that a core entity <code>X</code> does exist.</p><p>Now, let&#x27;s say a new service <code>CService</code> is required to be added to the mix to complete the existing flow. So, now we have four different dependencies under one orchestration service, and a split is mandatory. Since there&#x27;s no relationship whatsoever between <code>A</code>, <code>B</code> and <code>C</code>, a &#x27;No-Normalization&#x27; approach becomes the only option to realize a new design as follows:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/120102975-4d8b4400-c102-11eb-9582-6f95d17227e7.png" class="img_ev3q"></p><br><p>Each one of the above primitive services will be orchestrated with a core service <code>X</code> then gathered again under a coordination service. This case above is the worst case scenario, where a normalization of any size is impossible. Note, that the author of this Standard couldn&#x27;t come up with a realistic example unlike any others to show you how rare it is to run into that situation, so let&#x27;s a &#x27;No-Normalization&#x27; approach be your very last solution if you truly run out of options.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="232113-meaningful-breakdown">2.3.2.1.1.3 Meaningful Breakdown<a class="hash-link" href="#232113-meaningful-breakdown" title="Direct link to heading">​</a></h5><p>Regardless of the type of normalization that you will need to follow. You have to make sure that your grouped services represent a common meaning. For instance, putting together a <code>StudentProcessingService</code> and <code>LibraryProcessingService</code> must require a commonality in function between the two. A good example of that would be <code>StudentRegistrationOrchestrationService</code> for instance. The registration process requires adding a new student record and creating a library card for that very same student.</p><p>Implementing orchestration services without intersection between two or three entities per operation defeats the whole purpose of having an orchestration service. This condition is satisfied if at least one intersection between two entities has occurred. An orchestration service may then have other operations that we call &#x27;Pass-Through&#x27; where we propagate certain routines from their processing or foundation origins if they match the same contract.</p><p>Here&#x27;s an example:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class StudentOrchestrationService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async ValueTask&lt;Student&gt; RegisterStudentAsync(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Student addedStudent =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await this.studentProcessingService.AddStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LibraryCard libraryCard = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            await this.libraryCardPorcessingService.AddLibraryCardAsync(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                addedStudent.Id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return addedStudent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async ValueTask&lt;Student&gt; ModifyStudentAsync(Student student) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await this.studentProcessingService.ModifyStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the example above, our <code>StudentOrchestrationService</code> had an orchestration routine where it combined adding a student and creating a library card for that very same student. But additionally it also offers a &#x27;Pass-Through&#x27; function for a low-level processing service routine to modify a student.</p><p>&#x27;Pass-Through&#x27; routines must have the exact same contract as the rest of all other routines in any orchestration service. That&#x27;s our &#x27;Pure Contract&#x27; principle which dictates that any service should allow the very same contract as input and output or primitive types.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2322-contracts">2.3.2.2 Contracts<a class="hash-link" href="#2322-contracts" title="Direct link to heading">​</a></h3><p>Orchestration services may combine two or three different entities and their operations to achieve an advanced business logic. There are two situations when it comes to contract/models for orchestration services. One that stays true to the main entity of purpose. And one that is complex - a combinator orchestration service that tries to explicitly expose it&#x27;s inner target entities.</p><p>Let&#x27;s talk about these two scenarios in detail.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23220-physical-contracts">2.3.2.2.0 Physical Contracts<a class="hash-link" href="#23220-physical-contracts" title="Direct link to heading">​</a></h4><p>Some orchestration services are still single-purposed even though they may be combining two or three other higher order routines from multiple entities. For instance, an orchestration service that reacts to messages from some queue then persists these messages are single-purposed and single-entity orchestration services.</p><p>Let&#x27;s take a look at this code snippet:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class StudentOrchestrationService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IStudentEventProcessingService studentEventProcessingService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private readonly IStudentProcessingService studentProcessingService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public StudentOrchestrationService(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IStudentEventProcessingService studentEventProcessingService,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        IStudentProcessingService studentProcessingService)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.studentEventProcessingService = studentEventProcessingService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.studentProcessingService = studentProcessingService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ListenToEvents();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void ListenToEvents() =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.studentEventService.ListenToEvent(UpsertStudentAsync);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public async ValueTask&lt;Student&gt; UpsertStudentAsync(Student student)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await this.studentProcessingService.UpsertStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above example, the orchestration service still exposes a functionality that honors the physical model <code>Student</code> and internally communicates with several services that may provide completely different models. These are the scenarios where there&#x27;s a main purpose single entity and all other services are supporting services to ensure a successful flow for that very entity succeeds.</p><p>In our example here, the orchestration services <em>listens</em> to a queue where new student messages will be placed, then use that event to persist any incoming new students in the system. So the physical contract <code>Student</code> is the same language the orchestration service explicitly use as a model to communicate with upper stream services/exposers or others.</p><p>But there are other scenarios where a single entity is not the only purpose/target for an orchestration service. Let&#x27;s talk about that in detail.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23221-virtual-contracts">2.3.2.2.1 Virtual Contracts<a class="hash-link" href="#23221-virtual-contracts" title="Direct link to heading">​</a></h4><p>In some scenarios, an orchestration service may be required to create it&#x27;s own non-physical contracts to complete a certain operation. For instance, consider an orchestration service that is required to persist a social media post with a picture attached to it. The requirement here is to persist the picture in one database table, and the actual post (comments, authors and others) into a different database table in a relational model.</p><p>Now, the incoming model might be significantly different from what the actual physical models would look like. Let&#x27;s take a look at how would that look like in the real-world.</p><p>Consider having this model:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class MediaPost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Guid Id {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public string Content {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public DateTimeOffset Date {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public IEnumerable&lt;string&gt; Base64Images {get; set;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above contract <code>MediaPost</code> contains two different physical entities combined. The first is the actual post, including the <code>Id</code>, <code>Content</code> and <code>Date</code> and the second is the list of images attached to that very post.</p><p>here&#x27;s how an orchestration service would react to this incoming virtual model:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;MediaPost&gt; SubmitMediaPostAsync(MediaPost mediaPost)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Post post = MapToPost(mediaPost);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Media&gt; medias = MapToMedias(mediaPost);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Post addedPost =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await this.postProcessingService.AddPostAsync(post);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Medias&gt; addedMedias = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await this.mediaProcessingService.AddMediasAsync(medias);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return MapToMediaPost(addedPost, addedMedias); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Post MapToPost(MediaPost mediaPost)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new Post</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Id = mediaPost.Id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Content = mediaPost.Content,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CreatedDate = mediaPost.Date,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UpdatedDate = mediaPost.Date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public List&lt;Media&gt; MapToMedias(MediaPost mediaPost)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return mediaPost.Base64Images.Select(image =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Media</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Id = Guid.NewGuid(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            PostId = mediaPost.Id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Image = image,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CreatedDate = mediaPost.Date,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            UpdatedDate = mediaPost.Date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above code snippet shows the orchestration service deconstructing a given virtual model/contract <code>MediaPost</code> into two physical models, each one of them has it&#x27;s own separate processing service that handles it&#x27;s persistence. There are scenarios also where the virtual model gets deconstructed into one single model with additional details that are used for validation and verification with downstream processing or foundation services.</p><p>There are also hybrid situations where the incoming virtual model may have nested physical models in it. Which is something we can only allow with virtual models. Physical models shall stay anemic (contains no routines or constructors) and flat (contains no nested models) at all times to control complexity and focus responsibility.</p><p>In summary, Orchestration services may create their own contracts. These contracts may be physical or virtual. And a virtual contract may be a combination of one or many physical (or nested virtual) contracts or simply has it&#x27;s own flat design in terms of properties.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2322-cul-de-sac">2.3.2.2 Cul-De-Sac<a class="hash-link" href="#2322-cul-de-sac" title="Direct link to heading">​</a></h3><p>There are times where Orchestration services and it&#x27;s equivalent (coordination, management ... etc.) may not need an exposer component (controller for instance). That&#x27;s because these services may be listeners to certain events and communicating the event back into a processing or a foundation service at the same level where the event started or was received.</p><p>For instance, imagine building a simple application where it gets notified with messages from a queue then maps these messages into some local model to persist it in storage. In this case here, the incoming or input for these services isn&#x27;t necessarily through an exposer component anymore. The incoming messages can be received from a subscription to an event service or a queue. In this case the orchestration service would look something like the following:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/144501231-11ea13c9-81fa-4730-8840-a891a1d9edde.png" class="img_ev3q"></p><br><p> The <code>StudentEventOrchestrationService</code> in this case, listens to the messages for new students coming in and immediately converts that into models that can be persisted in the database.</p><p> Here&#x27;s an example:</p><p> Let&#x27;s start with a unit test for this pattern as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Fact]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void ShouldListenToProfileEvents()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // given . when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   this.profileEventOrchestrationService.ListenToProfileEvents();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   this.profileEventServiceMock.Verify(service =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       service.ListenToProfileEvent(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           this.profileEventOrchestrationService.ProcessProfileEventAsync),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   this.profileEventService.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   this.profileServiceMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   this.loggingBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Fact]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public async Task ShouldAddProfileAsync()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // given</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ProfileEvent randomProfileEvent =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       CreateRandomProfileEvent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ProfileEvent inputProfileEvent =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       randomProfileEvent;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   this.profileServiceMock.Setup(service =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       service.AddProfileAsync(inputProfileEvent.Profile));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   await this.profileEventOrchestrationService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       .ProcessProfileEventAsync(inputProfileEvent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   this.profileServiceMock.Verify(service =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       service.AddProfileAsync(inputProfileEvent.Profile),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   this.profileServiceMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   this.loggingBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   this.profileEventServiceMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p> The test here indicates an event listening has to occur first, then a persistence in the student service must match the outcome of mapping an incoming message to a given student.</p><p> Let&#x27;s try to make this test pass.</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public partial class ProfileEventOrchestrationService : IProfileEventOrchestrationService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   private readonly IProfileEventService profileEventService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   private readonly IProfileService profileService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   private readonly ILoggingBroker loggingBroker;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public ProfileEventOrchestrationService(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       IProfileEventProcessingService profileEventService,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       IProfileProcessingService profileService,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ILoggingBroker loggingBroker)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       this.profileEventService = profileEventService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       this.profileService = profileService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       this.loggingBroker = loggingBroker;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public void ListenToProfileEvents() =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   TryCatch(() =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       this.profileEventService.ListenToProfileEvent(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           ProcessProfileEventAsync);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   public ValueTask ProcessProfileEventAsync(ProfileEvent profileEvent) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   TryCatch(async () =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       await this.profileService.AddProfileAsync(profileEvent.Profile);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above example, the constructor of the Orchestration service subscribes to the events that would come from the <code>StudentEventService</code>, when an event occurs, the orchestration service will call the <code>ProcessingIncomingStudentMessageAsync</code> function to persist the incoming student into the database through a foundation or a processing service at the same level as the event service.</p><p>This pattern or characteristic is called the Cul-De-Sac. Where an incoming message will be a turn and head in a different direction for a different dependency. This pattern is very common is large enterprise-level applications where eventual-consistency is incorporated to ensure the system can scale and become resilient under heavy consumption. This pattern also prevents malicious attacks against your API endpoints since it allows processing queue messages or events whenever the service is ready to process them. We will discuss the details in the &#x27;The Standard Architecture&#x27;.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="233-responsibilities">2.3.3 Responsibilities<a class="hash-link" href="#233-responsibilities" title="Direct link to heading">​</a></h2><p>Orchestration services provide an advanced business logic. It orchestrates multiple flows for multiple entities/models to complete a single flow. Let&#x27;s discuss in detail what these responsibilities are:</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2330-advanced-logic">2.3.3.0 Advanced Logic<a class="hash-link" href="#2330-advanced-logic" title="Direct link to heading">​</a></h3><p>Orchestration services cannot exist without combining multiple routines from multiple entities. These entities may be different in nature, but they share a common flow or purpose. For instance, a <code>LibraryCard</code> as a model is fundamentally different from a <code>Student</code> model. However, they both share common purpose when it comes to student registration process. Adding a student record is required to register a student, but also assigning a library card to that very same student is a requirement for a successful student registration process.</p><p>Orchestration services ensures the correct routines for each entity are integrated, but also ensures these routines are called in the right order. Additionally, orchestration services are responsible for rolling back in case of a failing operation if needed. These three aspects are what constitutes an orchestration effort across multiple routines, entities or contracts.</p><p>Let&#x27;s talk about those in detail.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23300-flow-combinations">2.3.3.0.0 Flow Combinations<a class="hash-link" href="#23300-flow-combinations" title="Direct link to heading">​</a></h4><p>We spoke earlier about orchestration services combining multiple routines to achieve a common purpose or a single flow. This aspect of orchestration services can serve as both a fundamental characteristic but also a responsibility. And orchestration service without at least one routine that combines two or three entities is not considered truly an orchestration. Integrating with multiple services without a common purpose is a better fit definition for Aggregation services which we will discuss later in this services chapter.</p><p>But within the flow combination comes the unification of contract. I call it mapping and branching. Mapping an incoming model into multiple lower-stream services models then branching the responsibility across these services.</p><p>Just like the previous services, Orchestration services are responsible during their flow combination to ensure the purity of the exposed input and output contracts. Which becomes a bit more complex when combining multiple models. Orchestration services will continue to be responsible for mapping incoming contracts to their respective downstream services, but also ensures to map back the returned results from these services into the unified model.</p><p>Let&#x27;s bring back a previous code snippet to illustrate that aspect:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;MediaPost&gt; SubmitMediaPostAsync(MediaPost mediaPost)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Post post = MapToPost(mediaPost);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Media&gt; medias = MapToMedias(mediaPost);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Post addedPost =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await this.postProcessingService.AddPostAsync(post);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;Medias&gt; addedMedias = </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await this.mediaProcessingService.AddMediasAsync(medias);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return MapToMediaPost(addedPost, addedMedias); </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private Post MapToPost(MediaPost mediaPost)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new Post</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Id = mediaPost.Id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Content = mediaPost.Content,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CreatedDate = mediaPost.Date,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UpdatedDate = mediaPost.Date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private List&lt;Media&gt; MapToMedias(MediaPost mediaPost)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return mediaPost.Base64Images.Select(image =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Media</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Id = Guid.NewGuid(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            PostId = mediaPost.Id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Image = image,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CreatedDate = mediaPost.Date,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            UpdatedDate = mediaPost.Date</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private MediaPost MapToMediaPost(Post post, List&lt;Media&gt; medias)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new MediaPost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Id = post.Id,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Content = post.Content,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Date = post.CreatedDate,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Base64Images = medias.Select(media =&gt; media.Image)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see in the above example, the mapping and branching doesn&#x27;t just happen on the way in. But a reverse action has to be taken on the way out. It&#x27;s a violation of The Standard to return the same input object that was passed in. That takes away any visibility on any potential changes that happened to the incoming request during persistence. The duplex mapping should substitute the need to dereference the incoming request to ensure no unexpected internal changes have occurred.</p><p>Note that it&#x27;s also recommended to break the mapping logic into its own aspect/partial class file. Something like <code>StudentOrchestrationService.Mappings.cs</code> to make sure the only thing left there is the business logic of orchestration.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23301-call-order">2.3.3.0.1 Call Order<a class="hash-link" href="#23301-call-order" title="Direct link to heading">​</a></h4><p>Calling routines in the right order can be crucial to any orchestration process. For instance, a library card cannot be created unless a student record is created first. Enforcing the order here can split into two different types. Let&#x27;s talk about those here for a bit.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="233010-natural-order">2.3.3.0.1.0 Natural Order<a class="hash-link" href="#233010-natural-order" title="Direct link to heading">​</a></h5><p>The natural order here refers to certain flows that cannot be executed unless a prerequisite of input parameters is retrieved or persisted. For instance, imagine a situation where a library card cannot be created unless a student unique identifier is retrieved first. In this case here we don&#x27;t have to worry about testing certain routines were called in the right order because it comes naturally with the flow.</p><p>here&#x27;s a code example of this situation:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;LibraryCard&gt; CreateLibraryCardAsync(LibraryCard libraryCard)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student student = await this.studentProcessingService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .RetrieveStudentByIdAsync(libraryCard.StudentId));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.libraryCardProcessingService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .CreateLibraryCardAsync(libraryCard, student.Name);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the example above, having a student <code>Name</code> is a requirement to create a library card. Therefore, the orchestration of order here comes naturally as part of the flow without any additional effort.</p><p>Let&#x27;s talk about the second type of order - Enforced Order.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="233011-enforced-order">2.3.3.0.1.1 Enforced Order<a class="hash-link" href="#233011-enforced-order" title="Direct link to heading">​</a></h5><p>Imagine the very same example above, but instead of the library card requiring a student name it instead just needs the student <code>Id</code> which is already enclosed in the incoming request model. Something like this:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;LibraryCard&gt; CreateLibraryCardAsync(LibraryCard libraryCard)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    await this.studentProcessingService.VerifyEnlistedStudentExistAsync(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        libraryCard.StudentId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return await this.libraryCardProcessingService.CreateLibraryCardAsync(libraryCard);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ensuring a verify enlisted student exists has happened before creating a library card might become a challenge to achieve naturally because there&#x27;s no dependency between a return value of one routine and the input parameters of the next. In other words, there is nothing that the <code>VerifyEnlistedStudentExistAsync</code> function returns that the <code>CreateLibraryCardAsync</code> function cares about in terms of input parameters.</p><p>In this case here an enforced type of order must be implemented through unit tests. A unit test for this routine would require to verify not just the dependency have been called with the right parameters, but also that they are called in the right <em>order</em> let&#x27;s take a look at how that would be implemented:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[Fact]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public async Task ShouldCreateLibraryCardAsync()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // given</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student someStudent = CreateRandomStudent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LibraryCard randomLibraryCard = CreateRandomLibraryCard();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LibraryCard inputLibraryCard = randomLibraryCard;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LibraryCard createdLibraryCard = inputLibraryCard;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LibraryCard expectedLibraryCard = inputLibraryCard.DeepClone();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Guid studentId = inputLibraryCard.StudentId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var mockSequence = new MockSequence();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.studentProcessingServiceMock.InSequence(mockSequence).Setup(service =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.VerifyEnlistedStudentExistAsync(studentId))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .Returns(someStudent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.libraryCardProcessingServiceMock.InSequence(mockSequence).Setup(service =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.CreateLibraryCardAsync(inputLibraryCard))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ReturnsAsync(createdLibraryCard);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LibraryCard actualLibraryCard = await this.libraryCardOrchestrationService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .CreateLibraryCardAsync(inputLibraryCard);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actualLibraryCard.Should().BeEquivalentTo(expectedLibraryCard);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.studentProcessingServiceMock.Verify(service =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.VerifyEnlistedStudentExistAsync(studentId),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.libraryCardProcessingServiceMock.Verify(service =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.CreateLibraryCardAsync(inputLibraryCard),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.studentProcessingServiceMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.libraryCardProcessingServiceMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>From the example above, the mock framework here is being used to ensure a certain order is being enforced when it comes to calling these dependencies. This way we enforce a certain implementation within any given method to ensure a non-naturally connected dependencies are being sequentially called in the exact right order.</p><p>It&#x27;s more likely that the form of ordering leans more towards enforced than natural when orchestration services reach the maximum number of dependencies they may have at any point in time.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="23302-exceptions-mapping-wrapping--unwrapping">2.3.3.0.2 Exceptions Mapping (Wrapping &amp; Unwrapping)<a class="hash-link" href="#23302-exceptions-mapping-wrapping--unwrapping" title="Direct link to heading">​</a></h4><p>This responsibility is very similar to flow-combinations. Except that in this case orchestration services unify all the exceptions that may occur out of any of its dependencies into one unified categorical exception model. Let&#x27;s start with an illustration of what that mapping may look like:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/145294325-0818a2dd-a017-43af-b1f0-fa5c93a9218c.png" class="img_ev3q"></p><br><p>In the illustration above, you will notice that validation and dependency validation exceptions thrown from downstream dependency services are being mapped into one unified dependency exception at the orchestration level. This practice allows upstream consumers of that very orchestration service to determine the next course of action based on one categorical exception type instead of four or in the case of three dependencies it would be six categorical dependencies.</p><p>Let&#x27;s start with a failing test to materialize our idea here:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public static TheoryData DependencyValidationExceptions()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string exceptionMessage = GetRandomMessage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var innerException = new Xeption(exceptionMessage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var studentValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new StudentValidationException(innerException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var studentDependencyValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new StudentDependencyValidationException(innerException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var libraryCardValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new LibraryCardValidationException(innerException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var libraryCardDependencyValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new LibraryCardDependencyValidationException(innerException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new TheoryData&lt;Xeption&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        studentValidationException,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        studentDependencyValidationException,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        libraryCardValidationException,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        libraryCardDependencyValidationException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Theory]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[MemberData(nameof(DependencyValidationExceptions))]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public async Task ShouldThrowDependencyValidationExceptionOnCreateIfDependencyValidationErrorOccursAndLogItAsync(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Xeption dependencyValidationException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // given</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student someStudent = CreateRandomStudent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var expectedStudentOrchestrationDependencyValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new StudentOrchestrationDependencyValidationException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            dependencyValidationException.InnerException as Xeption);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.studentServiceMock.Setup(service =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.AddStudentAsync(It.IsAny&lt;Student&gt;()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .ThrowsAsync(dependencyValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ValueTask&lt;Student&gt; addStudentTask =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        await this.studentOrchestrationService.AddStudentAsync(someStudent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StudentOrchestrationDependencyValidationException</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        actualStudentOrchestrationDependencyValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                await Assert.ThrowsAsync&lt;StudentOrchestrationDependencyValidationException&gt;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    addStudentTask.AsTask);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    actualStudentOrchestrationDependencyValidationException.Should()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .BeEquivalentTo(expectedStudentOrchestrationDependencyValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.studentServiceMock.Verify(service =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.AddStudentAsync(It.IsAny&lt;Student&gt;()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.Verify(broker =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        broker.LogError(It.Is(SameExceptionAs(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            expectedStudentOrchestrationDependencyValidationException))),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.libraryCardServiceMock.Verify(service =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        service.AddLibraryCard(It.IsAny&lt;Guid&gt;()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Times.Once);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.studentServiceMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.loggingBrokerMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.libraryCardServiceMock.VerifyNoOtherCalls();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the test above, we are verifying that any of the four aforementioned exceptions on occurrence, they would be mapped into a <code>StudentOrchestrationDependencyValidationException</code>. We maintain the original localized exception as an inner exception. But we unwrap the categorical exception at this level to maintain the original issue as we go upstream.</p><p>These exceptions are mapped under a dependency validation exception because they originate from a dependency or a dependency of a dependency downstream. For instance, if a storage broker throws an exception that is deemed to be a dependency validation (something like <code>DuplicateKeyException</code>). The broker-neighboring service would map that into a localized <code>StudentAlredyExistException</code> then wrap that exception in a categorical exception of type <code>StudentDependencyValidationException</code>. When that exception propagates upstream to a processing or an orchestration service, we lose the categorical exception as we have already captured it under the right scope of mapping. Then we continue to embed that very localized exception under the current service dependency validation exception.</p><p>Let&#x27;s try to make this test pass:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public partial class StudentOrchestrationService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private delegate ValueTask&lt;Student&gt; ReturningStudentFunction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private async ValueTask&lt;Student&gt; TryCatch(ReturningStudentFunction returningStudentFunction)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return await returningStudentFunction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (StudentValidationException studentValidationException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw CreateAndLogDependencyValidationException(studentValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (StudentDependencyValidationException studentDependencyValidationException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw CreateAndLogDependencyValidationException(studentDependencyValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (LibraryCardValidationException libraryCardValidationException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw CreateAndLogDependencyValidationException(libraryCardValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        catch (LibraryCardDependencyValidationException libraryCardDependencyValidationException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw CreateAndLogDependencyValidationException(libraryCardDependencyValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private StudentOrchestrationDependencyValidationException CreateAndLogDependencyValidationException(Xeption exception)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var studentOrchestrationDependencyValidationException =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new StudentOrchestrationDependencyValidationException(exception.innerException as Xeption);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.loggingBroker.LogError(studentOrchestrationDependencyValidationException);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw studentOrchestrationDependencyValidationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now we can use the <code>TryCatch</code> as follows:</p><div class="language-csharp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-csharp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public async ValueTask&lt;Student&gt; AddStudentAsync(Student student) =&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TryCatch(async () =&gt; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Student addedStudent = await this.studentService.AddStudentAsync(student);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LibraryCard libraryCard = await this.libraryCard.AddLibraryCard(addedStudent.Id);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return addedStudent;  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can see now in the implementation that we mapped all four different types of external downstream services validation exceptions into one categorical exception and then maintained the inner exception for each one of them.</p><p>The same rule applies to dependency exceptions. Dependency exceptions can be both Service and Dependency exceptions from downstream services. For instance, in the above example, calling a student service may produce <code>StudentDependencyException</code> and <code>StudentServiceException</code>. Both of these categorical exceptions will be unwrapped from their categorical layer and have their local layer wrapped in one unified new orchestration-level categorical exception under <code>StudentOrchestrationDependencyException</code>. The same thing applies to all other dependency categorical exceptions like <code>LibraryCardDependencyException</code> and <code>LibraryCardServiceException</code>.</p><p>It&#x27;s extremely important to unwrap and wrap localized exceptions from downstream services with categorical exceptions at the current service layer to ensure at the Exposers layer these exceptions can be easily handled and mapped into whatever the nature of the exposer component dictates. In the case of an Exposer component of type API Controller, the mapping would produce Http Status Codes. In the case of UI Exposer components it would be mapped to meaningful text to the end users.</p><p>We will discuss further upstream in this Standard when to determine to expose localized inner exceptions details where end-users are not required to take any action. This is exclusive to dependency and service level exceptions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="234-variations">2.3.4 Variations<a class="hash-link" href="#234-variations" title="Direct link to heading">​</a></h2><p>Orchestration services have several variations depending on where they stand in the overall low-level architecture. For instance, an orchestration service depending on downstream orchestration services is called a Coordination Service. An orchestration service working with multiple coordination services as dependencies is called a Management Service. These variants are all in essence an orchestration service with an uber-level business logic.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2340-variants-levels">2.3.4.0 Variants Levels<a class="hash-link" href="#2340-variants-levels" title="Direct link to heading">​</a></h3><p>Let&#x27;s take a look at the possible variants for orchestration services and where they would be positioned:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/147461598-e7fe6b48-976a-4787-bd97-11e7faf131ee.png" class="img_ev3q"></p><br><p> In my personal experience, I&#x27;ve rarely had to resolve to an Uber Management service. The idea of the limitation here in terms of dependencies and variations of orchestration-like services is to help engineers re-think the complexity of their logic. But admittedly there are situations where the complexity is an absolute necessity, therefore Uber-Management services exist as an option.</p><p> The following table should guide the process of developing variants of orchestration services based on the level:</p><table><thead><tr><th>Variant</th><th>Dependencies</th><th>Consumers</th><th>Complexity</th></tr></thead><tbody><tr><td>Orchestrations Services</td><td>Foundation or Processing Services</td><td>Coordination Services</td><td>Low</td></tr><tr><td>Coordination Services</td><td>Orchestration Services</td><td>Management Services</td><td>Medium</td></tr><tr><td>Management Services</td><td>Coordination Services</td><td>Uber Management Services</td><td>High</td></tr><tr><td>Uber Management Services</td><td>Management Services</td><td>Aggregation, Views or Exposer Components</td><td>Very High</td></tr></tbody></table><p> Working beyond Uber Management services in an orchestration manner would require a deeper discussion and a serious consideration of the overall architecture. Some future versions The Standard might be able to address this issue in what I call &quot;The Lake House&quot; but that is outside of the scope of this version of The Standard.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2341-unit-of-work">2.3.4.1 Unit of Work<a class="hash-link" href="#2341-unit-of-work" title="Direct link to heading">​</a></h3><p> With the variations of orchestration services, I highly recommend staying true to the unit of work concept. Where every request can do one thing and one thing only including it&#x27;s pre-requisites. For instance, if you need to register a student in some school, You may require also adding a guardian, contact information and some other details. Eventing these actions can greatly decrease the complexity of the flow and lower the risk of any failures in downstream services.</p><p> Here&#x27;s a visualization for a complex single-threaded approach:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/147462984-84e6dabd-bf27-413a-8e79-2659a24c37c0.png" class="img_ev3q"></p><br><p> The solution above is a working solution for registering a student. We needed to include guardian information, library cards, classes ... etc. These dependencies can be broken down in terms of eventing and allowing other services to pick up where the single-threaded services leaves off to continue the registration process. Something like this:</p><br><p><img loading="lazy" src="https://user-images.githubusercontent.com/1453985/147463233-466a055f-ce95-4911-92cd-7b173b2a37df.png" class="img_ev3q"></p><br><p>  The incoming request in the above example would be turned into events, where each one of these events would be notifying its own orchestration services in a cul-de-sac manner as we discussed above in section 2.3.2.2. What that means is that a single thread is no longer responsible for the success of each and every dependency in the system. Instead, every event-listening broker would handle its own process in a much, much simplified way.</p><p>  That approach does not guarantee an immediate response of success or failure to the requestor. It&#x27;s an eventual-consistency pattern where the client would get an <code>Accepted</code> message or its equivalent based on the communication protocol to let them know that a process has started but there&#x27;s no guarantee of any results yet until it&#x27;s done.</p><p>  It&#x27;s also important to mention that an extra layer of resiliency can be added to these events by temporarily storing them in Queue-like components or memory-based temporary storages; depending on the criticality of the business.</p><p>  But an eventual consistency approach isn&#x27;t always a good solution if the client on the other side is waiting for a response. Especially in a much critical situations where an immediate response is required. This problem can be solved through Fire-n-Observe queues that we will discuss in future version of The Standard.</p><p>[*][Introduction to Orchestration Services]<!-- -->(<a href="https://www.youtube.com/watch?v=OP6HcIpXduE" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=OP6HcIpXduE</a>)</p><p>[*][Cul-De-Sac Pattern for Orchestration Services]<!-- -->(<a href="https://www.youtube.com/watch?v=C8Sm1kSKF1o" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=C8Sm1kSKF1o</a>)</p><p>[*][Cul-De-Sac Pattern for Coordination Services]<!-- -->(<a href="https://www.youtube.com/watch?v=8KZIw_IJC0U" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=8KZIw_IJC0U</a>)</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/2. Services/2.3 Orchestrations/2.3 Orchestrations.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/The-Standard/docs/Services/2.2 Processings/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">2.2 Processing Services (Higher-Order Business Logic)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/The-Standard/docs/Services/2.4 Aggregations/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">2.4 Aggregation Services (The Knot)</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#230-introduction" class="table-of-contents__link toc-highlight">2.3.0 Introduction</a></li><li><a href="#231-on-the-map" class="table-of-contents__link toc-highlight">2.3.1 On The Map</a></li><li><a href="#232-characteristics" class="table-of-contents__link toc-highlight">2.3.2 Characteristics</a><ul><li><a href="#2320-language" class="table-of-contents__link toc-highlight">2.3.2.0 Language</a></li><li><a href="#2321-dependencies" class="table-of-contents__link toc-highlight">2.3.2.1 Dependencies</a></li><li><a href="#2322-contracts" class="table-of-contents__link toc-highlight">2.3.2.2 Contracts</a></li><li><a href="#2322-cul-de-sac" class="table-of-contents__link toc-highlight">2.3.2.2 Cul-De-Sac</a></li></ul></li><li><a href="#233-responsibilities" class="table-of-contents__link toc-highlight">2.3.3 Responsibilities</a><ul><li><a href="#2330-advanced-logic" class="table-of-contents__link toc-highlight">2.3.3.0 Advanced Logic</a></li></ul></li><li><a href="#234-variations" class="table-of-contents__link toc-highlight">2.3.4 Variations</a><ul><li><a href="#2340-variants-levels" class="table-of-contents__link toc-highlight">2.3.4.0 Variants Levels</a></li><li><a href="#2341-unit-of-work" class="table-of-contents__link toc-highlight">2.3.4.1 Unit of Work</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/The-Standard/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/The-Standard/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/The-Standard/assets/js/runtime~main.06584d35.js"></script>
<script src="/The-Standard/assets/js/main.1bcd0719.js"></script>
</body>
</html>